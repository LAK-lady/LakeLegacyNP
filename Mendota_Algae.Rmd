---
title: "Mendota_Algae"
author: "Lauren A. Knose, ORISE-EPA"
date: '2023-02-15'
output: html_document
---

The following text and code documents how algal data was processed and analyzed.
Data was also converted to time series.

# Step 1. Load dependent packages and data:

a) loading the dependent packages...
```{r}
library(ggplot2) #needed for plots
library(ggbreak) #needed for plot scale breaks
library(dplyr) #needed for reshaping/reformaing data
library(lubridate) #needed for reformatting data and using "year" function
library(DiagrammeR)
library(plotly) #needed for making 3D plots
```

Packages loaded.

b) loading the chlorophyll-a data...
```{r}
Chl<- read.csv(file="Original_data/ntl38_v5_chl.csv", header=TRUE) #has chl data
```

Chlorophyll-a data loaded. 

c) loading the phytoplankton data...
```{r}
phyto<-read.csv(file="Original_data/ntl88_v13_phytoplankton.csv", header=TRUE) #has the phytoplankton community dataset
```

Phytoplankton community data loaded. 


# Step 2. Filter and transform data:

a) filter and transform data for total algal biomass (as Chl-a) by sample date...

```{r}
Me_Chl<- Chl %>%
  mutate(Chla_ugL= tri_chl_spec) %>% #assign variable name and units to column with data
  filter(!is.na(Chla_ugL)) %>% #removes NAs in chl-a data
  filter(lakeid=="ME", #filter for Lake Mendota
         depth_range_m=="0-8", #integrated sample from 0 to 8m
         rep=="1") %>% #remove QA analytic replicates
  mutate(sampledate=as.Date(sampledate,
                            origin="1899-12-30")) %>% #tells R to format as date
  select(sampledate, Chla_ugL) #selects only fields of interest

date_range<- seq( #creates a vector of sequence data
  min(Me_Chl$sampledate), #starting at the first sample date
  max(Me_Chl$sampledate), #ending at the last sample date
  by="1 day") #observations every day  
interpolated<- approx( #creates a vector of data that linearly interpolates 
  Me_Chl$sampledate, #across date
  Me_Chl$Chla_ugL, #the predicted values of Hypo P: Epi P ratio
  xout=date_range) #for every 1 day
Chla_interp <- data.frame( #creates a new data frame that has 
  sampledate = as.Date(interpolated$x), #measurements every 14 days
                             Chla_ugL=interpolated$y) #predicted hypo: epi P ratio
Me_Chla_water<- Chla_interp %>%
  mutate(Yr=as.integer(year(sampledate)), #adds field with year
         MoYr=format(sampledate, "%m/01/%Y"), #adds field with month and year
         daynum=as.integer(yday(sampledate)), #adds field with Julian date
         Mo=as.integer(month(sampledate))) #adds field with month)
plot(Me_Chla_water$sampledate, Me_Chla_water$Chla_ugL,
     xlab="Date",
     ylab="Total Chl-a (ugL)") #plots the new time series
```

```{r}
write.csv(Me_Chla_water, file = "Cleaned_data/Mendota_Chl.csv") #save new file in folder "Cleaned_data"
```

Chl-a by sample date complete. File saved in Cleaned_data folder.

b) filter data for cyanobacteria relative biovolume by sample date...

```{r}
Me_cyanoRB<- phyto %>%
  filter(lakeid=="ME") %>% #filters data for Lake Mendota 
  filter(depth_range=="0-8m") %>% #filter for depth 0-8m
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30")) %>% #tells R to format 
          #data as date
  filter(division=="Cyanophyta") %>%
  group_by(sampledate) %>% #group all observations by sample date and 
  #division
  summarize(relbiovol=sum(relative_total_biovolume), #add all biovoumes together
            cellsmL=sum(cells_per_ml)) %>% #adds all the cells/mL together
  filter(relbiovol<=100) %>% #there is 1 record  that had > 100 %, must be error         
  mutate(daynum=as.integer(format(sampledate, "%j")), #adds field with Julian day
         MoYr=format(sampledate, "%m/01/%Y"), #add field with month/year
         Yr=as.integer(format(sampledate, "%Y")), #adds field with year
         Mo=as.integer(format(sampledate, "%m")))  #adds field with month
write.csv(Me_cyanoRB, file="Cleaned_data/Mendota_Cyano.csv") #use if first time running program
```

Cyanobacteria as percent of total biovolume and as cells/mL by sample date complete. File saved in Cleaned_data folder.

# Step 3.  Summarize and view the data:

a) Plot Chl-a by day of year...
```{r}
ggplot(data=Me_Chla_water, 
       aes(x=daynum,y=Chla_ugL)) + 
  geom_point(aes(col=Yr))+
  labs(title="Lake Mendota, WI", #plot title
       x="Day of Year", #x axis label
       y="Extracted Chl-a (ug/L)", #y axis label
       caption="Grey shading indicates CyanoHAB season, mid-Jul to mid-Sep.") + 
  ylim(0, max(Me_Chla_water$Chla_ugL)) +
  scale_x_continuous(breaks = seq(0, max(Me_Chla_water$daynum), #places axis tick marks
                                  by=30)) + #every 30 days (1 month) - CHANGE AS
  # NEEDED
  theme_classic()+
  scale_color_continuous(name="Year")+
  geom_smooth() + #adds loess curve (moving average regression model)
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=195, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=255, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
```

b) Plot Chl-a each year, with coding for CyanoHAB severity:

```{r}
ggplot(data=Me_Chl, 
       aes(x=daynum, y=Chla_ugL)) + 
  geom_point() +
  geom_line() +
  scale_y_continuous(trans="log10") +
  facet_wrap(~Yr) +
  labs(title="Lake Mendota, WI", 
       x="Day of Year", 
       y="Total Algal Biomass as Chl-a (ug/L)",
       caption="Grey shading indicates CyanoHAB season, mid-July to mid-Sept.") +
  theme_classic()+
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=195, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=255, xmax=Inf, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', xmin=0, xmax=Inf, ymin=0, ymax=10, alpha=.2, fill='green') + #low/no CyanoHAB
  annotate('rect', xmin=0, xmax=Inf, ymin=10, ymax=20, alpha=.2, fill='orange')+ #moderate CyanoHAB
  annotate('rect', xmin=0, xmax=Inf, ymin=20, ymax=Inf, alpha=.2, fill='red') #severe CyanoHAB
```

c) Plot Cyanobacteria relative biovolume by day of year...

```{r}
ggplot(data=Me_cyanoRB, aes(x=daynum, y=relbiovol)) + 
  geom_point() + 
  labs(title = "Lake Mendota, WI",
       x="Day of Year",
       y="Cyanobacteria relative biovolume (% of total algal biovolume)",
       caption="Grey shading indicates CyanoHAB season, mid-July to mid-Sept.") +
  theme_classic()+
  geom_hline(yintercept = 50, lty="dashed", col="red") +
  geom_smooth() + #adds loess curve (moving average regression model)
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=195, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=255, xmax=Inf, ymin=0, ymax=Inf) #shadow box highlights CyanoHAB season
```

d) Plot Cyanobacteria relative biovolume by year...

```{r}
ggplot(data=Me_cyanoRB, aes(x=daynum, y=relbiovol)) + 
  geom_point() + 
  facet_wrap(~Yr) +
  labs(title = "Lake Mendota, WI",
       x="Day of Year",
       y="Cyanobacteria relative biovolume (% of total algal biovolume)",
       caption="Grey shading indicates CyanoHAB season, mid-July to mid-Sept. \n
       Red dashed horizontal line is set at 50% total biovolume. \n
       Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_hline(yintercept = 50, lty="dashed", col="red") +
  geom_smooth() + #adds loess curve (moving average regression model)
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=195, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=255, xmax=Inf, ymin=0, ymax=Inf) #shadow box highlights CyanoHAB season
```

# Step 4. Analyze the response variables by predictors:

a) Question: Does epilimnion total P concentration correlate with chl-a?

combining data files...
```{r}
Chl_moyr<- Me_Chl %>%
  group_by(MoYr) %>%
  summarise(Avg_Chla_ugL=mean(Chla_ugL, na.rm=TRUE)) %>%
  mutate(MoYr=as.Date(MoYr, format="%m/%d/%Y", origin="1899-12-30"))
P_Chl<- merge(Chl_moyr, Pratio, by="MoYr", all=TRUE)
P_Chl<- P_Chl %>%
  filter(!is.na(TotP_mgL_Epi),
         !is.na(TotP_mgL_Hypo)) 
```

setting up plot...

```{r}
ggplot(data=P_Chl, aes(x=TotP_mgL_Epi, y=Avg_Chla_ugL))+
  geom_point() + 
  scale_y_continuous(trans="log10") +
  labs(title = "Lake Mendota, WI",
       x="Epilimnion total phosphorus (mg/L)",
       y="Total Algal Biomass as Chl-a (ug/L), log scale",
       caption= "Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_smooth()  #adds loess curve (moving average regression model)
```

b) Question: Does hypolimion total P concentration correlate with Chl-a?

```{r}
ggplot(data=P_Chl, aes(x=TotP_mgL_Hypo, y=Avg_Chla_ugL))+
  geom_point() + 
  scale_y_continuous(trans="log10") +
  labs(title = "Lake Mendota, WI",
       x="Hypolimnion total phosphorus (mg/L)",
       y="Total Algal Biomass as Chl-a (ug/L), log scale",
       caption= "Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_smooth()  #adds loess curve (moving average regression model)
```

c) Question: Does Hypo: Epi total P concentration correlate with Chl-a?

```{r}
ggplot(data=P_Chl, aes(x=HE_ratio_TotP_mgL, y=Avg_Chla_ugL))+
  geom_point() + 
  scale_y_continuous(trans="log10") +
  scale_x_continuous(trans="log10") +
  labs(title = "Lake Mendota, WI",
       x="Hypo: Epi total phosphorus ratio (mg/L)",
       y="Total Algal Biomass as Chl-a (ug/L), log scale",
       caption= "Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_smooth()  #adds loess curve (moving average regression model)
```


d) Question: Does epilimnion total P concentration correlate with cyano relative biovolume?

combining data files...
```{r}
CyanoRB_moyr<- Me_cyanoRB %>%
  mutate(MoYr=format(sampledate, "%m/01/%Y")) %>%
  group_by(MoYr) %>%
  summarise(Avg_relbiovol=mean(relbiovol, na.rm=TRUE)) %>%
  mutate(MoYr=as.Date(MoYr, format="%m/%d/%Y", origin="1899-12-30"))
P_Cyano<- merge(CyanoRB_moyr, Pratio, by="MoYr", all=TRUE)
P_Cyano<- P_Cyano %>%
  filter(!is.na(TotP_mgL_Epi),
         !is.na(TotP_mgL_Hypo)) 
```

setting up plot...

```{r}
ggplot(data=P_Cyano, aes(x=TotP_mgL_Epi, y=Avg_relbiovol))+
  geom_point() + 
  scale_y_continuous(trans="log10") +
  labs(title = "Lake Mendota, WI",
       x="Epilimnion total phosphorus (mg/L)",
       y="Cyanobacteria relative biovolume (as % of total), log scale",
       caption= "Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_smooth()  #adds loess curve (moving average regression model)
```

e) Question: Does hypolimnion total P concentration correlate with cyano relative biovolume?

```{r}
ggplot(data=P_Cyano, aes(x=TotP_mgL_Hypo, y=Avg_relbiovol))+
  geom_point() + 
  scale_y_continuous(trans="log10") +
  labs(title = "Lake Mendota, WI",
       x="Hypolimnion total phosphorus (mg/L)",
       y="Cyanobacteria relative biovolume (as % of total), log scale",
       caption= "Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_smooth()  #adds loess curve (moving average regression model)
```

f) Question: Does hypo: epi total P concentration correlate with cyano relative biovolume?

```{r}
ggplot(data=P_Cyano, aes(x=HE_ratio_TotP_mgL, y=Avg_relbiovol))+
  geom_point() + 
  scale_y_continuous(trans="log10") +
  scale_x_continuous(trans="log10") +
  labs(title = "Lake Mendota, WI",
       x="Hypolimnion total phosphorus (mg/L)",
       y="Cyanobacteria relative biovolume (as % of total), log scale",
       caption= "Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_smooth()  #adds loess curve (moving average regression model)
```

____________NEEDS UPDATED_____________________________

g) Question: Does total P loading from inflows predict Chl-a?

```{r}
ggplot(data=P_Chl, aes(x=TotPload_gday/1000, y=Chla_ugL)
       ) + 
  geom_point() +
  theme_classic() + 
  labs(title="Lake Mendota, WI",
       x="Total P loading (kg/day)",
       y="Total Algal Biomass (Chl-a ug/L)") +
  scale_y_continuous(trans = 'log10') +
  scale_x_continuous(trans = 'log10') 
```

Nope, not at all. Plot of Chla by total P loading shows no correlation.

Question: Does total P export in outflow predict Chl-a?

```{r}
ggplot(data=P_Chl, aes(x=TotPexp_gday/1000, y=Chla_ugL)
       ) + 
  geom_point() +
  theme_classic() + 
  labs(title="Lake Mendota, WI",
       x="Total P export (kg/day)",
       y="Total Algal Biomass (Chl-a ug/L)") +
  scale_y_continuous(trans = 'log10') +
  scale_x_continuous(trans = 'log10') 
```

Plot of Chla by total P export shows no correlation.

Question: Does total P stored/released predict Chl-a?

```{r}
ggplot(data=P_Chl, aes(x=P_stored_gday/1000, y=Chla_ugL)
       ) + 
  geom_point() +
  theme_classic() + 
  labs(title="Lake Mendota, WI",
       x="Total P stored (+) or released (-) (kg/day)",
       y="Total Algal Biomass (Chl-a ug/L)") +
  scale_y_continuous(trans = 'log10') +
  geom_vline(xintercept = 0, lty="dashed")
```

Plot of Chla by P stored or released shows almost all the data points to the left of the zero line. 

```{r}
ggplot(data=subset(P_Chl, daynum >= 195 & daynum <=255), aes(x=P_stored_gday/1000, y=Chla_ugL)) + 
  geom_point() +
  theme_classic() + 
  labs(title="CyanoHAB Season, Lake Mendota, WI",
       x="Total P stored (+) or released (-) (kg/day)",
       y="Total Algal Biomass (Chl-a ug/L)") +
  #scale_y_continuous(trans='log10') +
  #scale_x_continous(trans='log10) +
  geom_vline(xintercept = 0, lty="dashed")
```

Even during the CyanoHAB season, there's no relationship!!!


Plot Chl-a by internal load:

```{r}
ggplot(data=P_Chl_yr) + 
  geom_point(aes(x=Net_IL_gyr, y=MaxChl_ugL)) +
  geom_line(aes(x=TotPload_gyr, y=MaxChl_ugL)) +
  theme_classic() + 
  labs(title="CyanoHAB Season, Lake Mendota, WI",
       x="Net Annual Internal Loading (g/yr)",
       y="Maximum Algal Biomass (Chl-a ug/L)") 
  #scale_y_continuous(trans='log10') +
  #scale_x_continous(trans='log10) +
```





```{r}
hypo_sum_ME_TP<- read.csv(file.choose(), header=TRUE) #choose from Cleaned data folder
hypo_sum_ME_TP$mo=NULL #remove unwanted column
hypo_sum_ME_TP <- hypo_sum_ME_TP %>%
  mutate(sampledate=as.Date(sampledate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30")) #tells R to format 
          #data as date
sum_ME_Chl<- sum_ME_Chl %>%
  mutate(sampledate=as.Date(sampledate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30")) #tells R to format 
          #data as date
combA<- merge(hypo_sum_ME_TP, sum_ME_Chl, 
              by=c("sampledate", "year4", "daynum", "Use_Jdate"),
              all.x=TRUE,all.y=TRUE)
combA$sd_hypo_TP=NULL #don't need this column
combA<- na.omit(combA) #removes NAs (from 140 records to 59 records)

ggplot(data=combA, aes(x=(mean_hypo_TP*1000), y=Chl_ugL)) + 
  geom_point()+
  geom_smooth(method="lm", data=subset(combA, mean_hypo_TP > 0.1)) +
  geom_smooth(method="lm", data=subset(combA, mean_hypo_TP < 0.1)) +
  theme_classic()+
  labs(x="Hypolimion total P (ug/L)",
       y="Total algal biomass (ug Chl-a/L)",
       title="Summer, mid-July to mid-September, Lake Mendota, WI",
       caption="Source: Lake Mendota, North Temperate Lakes Dataset")
```

First, join the two tables...

```{r}
sum_ME_Chl<-read.csv(file.choose(), header=TRUE) #file in Cleaned_data folder
sum_ME_Chl$depth_range_m=NULL
sum_ME_Chl$mo=NULL
joined_TPChl<- merge(hypo_sum_ME_TP, sum_ME_Chl, by=c("sampledate", "year4",
                                                      "Use_Jdate","daynum"))
joined_TPChl_epi<-merge(epi_sum_ME_TP, sum_ME_Chl, by=c("sampledate", "year4",
                                                      "Use_Jdate","daynum"))
```

Then, build the plot for EPI TP...

```{r}
ylim.prim <- c(0, 0.15)   #total P range in mg/L
ylim.sec <- c(0, 60)    # chl-a range in ug/L

b <- diff(ylim.prim)/diff(ylim.sec)
a <- ylim.prim[1] - b*ylim.sec[1] 

ggplot(data=joined_TPChl_epi, aes(x=Use_Jdate)) + 
  facet_wrap(~year4) +
  geom_line(aes(y=totpuf_sloh)) +
  geom_point(aes(y = a + Chl_ugL*b)) +
  theme_classic() +
  theme(legend.justification=c("right", "top")) +
  labs(x="Day of Year", y="Mean Total P (ug/L)",
       title="Summer Epilimnion, mid-July to mid-September, Lake Mendota, WI",
       caption="Source: Lake Mendota,North Temperate Lakes Dataset",
       colour="Year") +
  scale_y_continuous(sec.axis=sec_axis(~ (. - a)/b, 
                                       name="Total Chlorophyll-a (ug/L)")) +
  geom_hline(yintercept=20/400, col="red", lty="dashed")
```

Then, build the plot for Hypo TP...

```{r}
ylim.prim <- c(0, 0.6)   #total P range in mg/L
ylim.sec <- c(0, 60)    # chl-a range in ug/L

b <- diff(ylim.prim)/diff(ylim.sec)
a <- ylim.prim[1] - b*ylim.sec[1] 

ggplot(data=joined_TPChl, aes(x=Use_Jdate)) + 
  facet_wrap(~year4) +
  geom_line(aes(y=mean_hypo_TP)) +
  geom_point(aes(y = a + Chl_ugL*b)) +
  theme_classic() +
  theme(legend.justification=c("right", "top")) +
  labs(x="Day of Year", y="Hypo Total P (ug/L)",
       title="Summer Hypolimnion, mid-July to mid-September, Lake Mendota, WI",
       caption="Source: Lake Mendota,North Temperate Lakes Dataset",
       colour="Year") +
  scale_y_continuous(sec.axis=sec_axis(~ (. - a)/b, 
                                       name="Total Chlorophyll-a (ug/L)")) +
  geom_hline(yintercept=20/100, col="red", lty="dashed")
```
