---
title: "Mendota_Pexternal_atmdep"
author: "Lauren A. Knose, ORISE-EPA"
date: '2023-05-24'
output: html_document
---

The purpose of this program is to calculate P load from atmospheric deposition. 
P load from atm = P_wet + P_dry.
P_wet = P concentration * daily Precipitation volume
P_dry = P deposition * Lake surface area


# Step 1. Load dependent packages and data needed:

a) Loading dependent packages...
```{r}
library(ggplot2) #needed for plots
library(dplyr) #needed for reshaping/reformaing data
library(lubridate) #needed for date functions
library(zoo) #needed to interpolate data
library(xts) #needed to convert data frame to time series
```

b) Loading data...
Note, ensure date data is formatted in R as Date.

```{r}
precip<- read.csv(file="Original_data/NOAA_Weather_Mendota_2012to2022.csv")
precip<- precip %>%
  mutate(sampledate=as.Date(sampledate, format="%m/%d/%Y", #reformat as date
                            origin="1899-12-30"))
precip<- precip %>%
  filter(!Precipitation_in=="T") %>% #remove flagged data ("T")
  mutate(Precipitation_in=as.numeric(Precipitation_in)) %>% #convert to numeric
  filter(!is.na(Precipitation_in)) #remove NAs
```

c) filter and mutate data as needed...
```{r}
km2_m2= 1000000/1 #conversion factor from km^2 to m^2
A_lake_m2 = 39.40*km2_m2 #surface area of lake in m^2 
mg_kg = 1/1000 #conversion factor from mg to kg

in_m = 1/39.3701 #conversion factor from in to m (1 m = 39.701 inches)
m3_L = 1000/1 #conversion factor from m^3 to L (1000 L = 1 m^3)

P_atm_dry = 0.17 #mg P/m2-day rate of P dry deposition during summer (Soranno et al 1997)
P_atm_wet = 0.032 #mg/L rate of P wet deposition

precip <- precip %>%
  mutate(dryP_atm_kgday = ((P_atm_dry*A_lake_m2)*mg_kg), #calculate dry P deposited
         wetP_atm_kgday = ((P_atm_wet*((Precipitation_in*in_m*A_lake_m2)*m3_L))*mg_kg), 
         #calculate wet P deposited
         totP_atm_kgday = (dryP_atm_kgday+wetP_atm_kgday) #calculate total P atm
# deposited every day
        ) 
```

# Step 2. Summarize adn view the data:

```{R}
precip_sum <- precip %>%
  mutate(daynum=format(sampledate, format = "%d"))
precip_avg <-precip_sum %>%
  filter(daynum >=195 & daynum <= 255)
```
The total external P loading from atmospheric deposition, during CyanoHAB season,
was on average `r mean(precip_avg$totP_atm_kgday, na.rm=TRUE)` kg/day.

```{r}
ggplot(data=precip, #need to subset data because of big gap between 2000 and 2008
       aes(x=sampledate, y=totP_atm_kgday)) +
  geom_point() +
  geom_line() + 
  theme_classic() +
  labs(x="Date", y="Total P deposited (wet and dry), in kg/day") +
  scale_x_date(date_breaks="1 year") 
```

# Step 3. Interpolate missing data: 

```{r}
date_range<- seq( #creates a vector of sequence data
  min(precip$sampledate), #starting at the first sample date
  max(precip$sampledate), #ending at the last sample date
  by="1 day") #observations every 14 days (bimonthly) 
interpolated<- approx( #creates a vector of data that linearly interpolates 
  precip$sampledate, #across date
  precip$totP_atm_kgday, #the predicted values of Hypo P: Epi P ratio
  xout=date_range) #for every 1 day
totP_atm_interp <- data.frame( #creates a new data frame that has 
  SampleDate = as.Date(interpolated$x), #measurements every 14 days
                             totP_atm_kgday=interpolated$y) #predicted hypo: epi P ratio
plot(totP_atm_interp,
     xlab="Date",
     ylab="Total P deposited from atmosphere (kg/day)") #plots the new time series
```

# Step 4. Save estimated P atm deposition as separate data file:

```{r}
write.csv(totP_atm_interp, file="Cleaned_data/Mendota_P_atm.csv")
```