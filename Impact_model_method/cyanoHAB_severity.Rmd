---
title: "cyanoHAB_severity.Rmd"
author: "Lauren A. Knose, ORISE-EPA"
date: '2024-03-26'
output: html_document
editor_options: 
  chunk_output_type: console
---

The following text and code documents how algal data was processed and analyzed.
Data was also converted to time series.

# Step 1. Load dependent packages and data:

a) loading the dependent packages...

```{r}
library(ggplot2) #needed for plots
library(ggbreak) #needed for plot scale breaks
library(dplyr) #needed for reshaping/reformating data
library(plotly) #needed for 3D plots
library(zoo) #needed for NA approx function
library(reshape2) #needed to reshape data tables long to wide
```

Packages loaded.

b) loading the chlorophyll-a data...

```{r}
Chl<- read.csv(file="Original_data/HarshaLake_Chla.csv", header=TRUE) #has chl data
```

Chlorophyll-a data loaded. 

c) loading the cyanoHAB severity data...

```{r}
cyanos<-read.csv(file="Cleaned_data/HarshaLake_cyanos.csv", header=TRUE) #has the phytoplankton community dataset
```

Data loaded. 

# Step 2. Define and reformat data:

a) defining and reformatting Chl-a data...

```{r}
### identify the labels used for fields ###
colnames(Chl) #identify labels for fields to filter
unique(Chl$id) #determine the label for the site
unique(Chl$Analyte) #determine the label for Chl-a
unique(Chl$Unit) #determine the label for units
head(Chl$Date) #determine format for sample date
unique(Chl$depth_ft) #determine the depth most data was collected
ft_m <- 0.3048 #conversion factor from feet to meter

### filter and reformat Chla data ###
HL_Chl<- Chl %>%
  mutate(sampledate=as.Date(Date, format="%m/%d/%Y", 
                            origin="1899-12-30"), #tells R to format field as Date
         Chla_ugL=Value,#add units to field with Chla data
         depth_m=depth_ft*ft_m) %>% #convert units
  filter(id=="BUO") %>% #filter for site
  select(sampledate, depth_m, Chla_ugL)

### determine which depth to select Chl-a values ###
stem(HL_Chl$depth_m)

### filter the Chla data for selected depth ###
HL_Chl<- HL_Chl %>%
  filter(depth_m==0,#filter for top layer Chla values
         !is.na(Chla_ugL)) %>% #filter out NAs
  select(sampledate, Chla_ugL) #selects only fields of interest
HL_Chl<- HL_Chl %>%
  group_by(sampledate) %>%
  summarize(Chla_ugL=mean(Chla_ugL, na.rm=TRUE)) %>%
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #adds field with year
         daynum=as.numeric(format(sampledate, "%j")))  #adds field with day
```

b) defining and reformatting cyanobacteria data...

```{r}
### identify the labels used for fields ###
head(cyanos$sampledate)#determine format for sample date

### reformat data ###
HL_cyanos<- cyanos %>%
  mutate(sampledate=as.Date(sampledate, format="%Y-%m-%d",
                            origin="1899-12-30"), #tells R to format field as Date
         Yr=as.numeric(format(sampledate, "%Y")), #adds field with year
         daynum=as.numeric(format(sampledate, "%j")))
```

Data defined and filtered. 

# Step 3. View the data available:

a) Plotting Chl-a data available...

```{r}
### plot Chla across date ###
ggplot(data=HL_Chl, aes(x=sampledate, y=Chla_ugL)) + #plots Chl-a across date
  geom_point() + #adds points at observations
  geom_line() + #adds lines between 
  theme_classic(base_size=12) +
  labs(x="Date", y="Chlorophyll-a (ug/L)")

### plot Chla across day number ###
ggplot(data=HL_Chl, #create limno plot with depth inverse on y-axis
       aes(x=daynum, #sampled date as x-axis
           y=Chla_ugL,
           color=Chla_ugL)) + #and data points colored by temperature
  geom_point() + #plot points
  facet_wrap(~Yr) + #make separate plot for each year
  theme_classic() +
  labs(x="Day of Year", y="Chlorophyll-a (ug/L)") 
```

Chl-a data plotted. 

b) Plotting CD data available...

```{r}
### plot CD across date ###
ggplot(data=HL_cyanos, aes(x=sampledate, y=CD_cellsmL/1000))+
  geom_point() +  #point plot 
  geom_line() + #lines between points
  theme_classic(base_size=12)+
  theme(axis.text.x = element_text(angle=45))+
  labs(x="Date", y="Cyanobacteria Density (10^3 cells/mL)")

### plot CD across day number ### 
ggplot(data=HL_cyanos, #create limno plot with depth inverse on y-axis
       aes(x=daynum, #sampled date as x-axis
           y=CD_cellsmL,
           color=CD_cellsmL)) + #and data points colored by temperature
  geom_point() + #plot points
  facet_wrap(~Yr) + #make separate plot for each year
  theme_classic() +
  labs(x="Day of Year", y="Cyano Density (cells/mL)") 
```

CD data plotted. 

# Step 4. Bin observations into same day number each year:

a) binning Chla day numbers...
```{r}
### define years of study ###
Yr<- c(2015, 2017, 2018, 2019) #define year start of study period
HL_Chl2<- HL_Chl %>%
  filter(Yr==2015|Yr==2017|Yr==2018|Yr==2019,
         daynum>=(152-7) & daynum<=(258+7))
HL_cyanos2<- HL_cyanos %>%
  filter(daynum>=(152-7) & daynum<=(258+7))

### define the observation return period ####
hist(HL_Chl2$daynum, breaks=14, main="Chl-a measurements") #see when most observations are made
hist(HL_cyanos2$daynum, breaks=14, main="Cyanobacteria density measurements")

daynum_bins<- seq(from=152, #define date start of CyanoHAB season
                  to=258, #define date end of CyanoHAB season
                  by=7) #creates a sequence every  days 
daynum_bins #prints the expected observation dates of data

### bin Chla sample dates to expected observation dates ###
HL_Chl2 <- HL_Chl2  %>% 
   mutate(daynum_bin=
         ifelse(daynum<(daynum_bins[2]-3.5), #if observation is <= bin 2 
                daynum_bins[1], #return bin 1
                ifelse(daynum>=(daynum_bins[2]-3.5) & #otherwise...
                         daynum<(daynum_bins[3]-3.5),#if observation is > bin 2  and <= bin 3 
              daynum_bins[2], #label bin 2
              ifelse(daynum>=(daynum_bins[3]-3.5)& #otherwise...
                       daynum<(daynum_bins[4]-3.5),
                     daynum_bins[3], 
                     ifelse(daynum>=(daynum_bins[4]-3.5)&
                              daynum<(daynum_bins[5]-3.5), 
                            daynum_bins[4], 
                            ifelse(daynum>=(daynum_bins[5]-3.5)&
                                     daynum<(daynum_bins[6]-3.5),
                                   daynum_bins[5],
                                   ifelse(daynum>=(daynum_bins[6]-3.5)&
                                     daynum<(daynum_bins[7]-3.5),
                                   daynum_bins[6],
                                   ifelse(daynum>=(daynum_bins[7]-3.5)&
                                     daynum<(daynum_bins[8]-3.5),
                                   daynum_bins[7],
                                   ifelse(daynum>=(daynum_bins[8]-3.5)&
                                     daynum<(daynum_bins[9]-3.5),
                                   daynum_bins[8],
                                   ifelse(daynum>=(daynum_bins[9]-3.5)&
                                     daynum<(daynum_bins[10]-3.5),
                                   daynum_bins[9],
                                   ifelse(daynum>=(daynum_bins[10]-3.5)&
                                     daynum<(daynum_bins[11]-3.5),
                                   daynum_bins[10],
                                   ifelse(daynum>=(daynum_bins[11]-3.5)&
                                     daynum<(daynum_bins[12]-3.5),
                                   daynum_bins[11],
                                   ifelse(daynum>=(daynum_bins[12]-3.5)&
                                     daynum<(daynum_bins[13]-3.5),
                                   daynum_bins[12],
                                   ifelse(daynum>=(daynum_bins[13]-3.5)&
                                     daynum<(daynum_bins[14]-3.5),
                                   daynum_bins[13],
                                   ifelse(daynum>=(daynum_bins[14]-3.5)&
                                     daynum<(daynum_bins[15]-3.5),
                                   daynum_bins[14],
                                   ifelse(daynum>=(daynum_bins[15]-3.5)&
                                     daynum<(daynum_bins[16]-3.5),
                                   daynum_bins[15], daynum_bins[16])
                                   )))))))))))))))  

HL_cyanos2 <- HL_cyanos2  %>% 
   mutate(daynum_bin=
         ifelse(daynum<(daynum_bins[2]-3.5), #if observation is <= bin 2 
                daynum_bins[1], #return bin 1
                ifelse(daynum>=(daynum_bins[2]-3.5) & #otherwise...
                         daynum<(daynum_bins[3]-3.5),#if observation is > bin 2  and <= bin 3 
              daynum_bins[2], #label bin 2
              ifelse(daynum>=(daynum_bins[3]-3.5)& #otherwise...
                       daynum<(daynum_bins[4]-3.5),
                     daynum_bins[3], 
                     ifelse(daynum>=(daynum_bins[4]-3.5)&
                              daynum<(daynum_bins[5]-3.5), 
                            daynum_bins[4], 
                            ifelse(daynum>=(daynum_bins[5]-3.5)&
                                     daynum<(daynum_bins[6]-3.5),
                                   daynum_bins[5],
                                   ifelse(daynum>=(daynum_bins[6]-3.5)&
                                     daynum<(daynum_bins[7]-3.5),
                                   daynum_bins[6],
                                   ifelse(daynum>=(daynum_bins[7]-3.5)&
                                     daynum<(daynum_bins[8]-3.5),
                                   daynum_bins[7],
                                   ifelse(daynum>=(daynum_bins[8]-3.5)&
                                     daynum<(daynum_bins[9]-3.5),
                                   daynum_bins[8],
                                   ifelse(daynum>=(daynum_bins[9]-3.5)&
                                     daynum<(daynum_bins[10]-3.5),
                                   daynum_bins[9],
                                   ifelse(daynum>=(daynum_bins[10]-3.5)&
                                     daynum<(daynum_bins[11]-3.5),
                                   daynum_bins[10],
                                   ifelse(daynum>=(daynum_bins[11]-3.5)&
                                     daynum<(daynum_bins[12]-3.5),
                                   daynum_bins[11],
                                   ifelse(daynum>=(daynum_bins[12]-3.5)&
                                     daynum<(daynum_bins[13]-3.5),
                                   daynum_bins[12],
                                   ifelse(daynum>=(daynum_bins[13]-3.5)&
                                     daynum<(daynum_bins[14]-3.5),
                                   daynum_bins[13],
                                   ifelse(daynum>=(daynum_bins[14]-3.5)&
                                     daynum<(daynum_bins[15]-3.5),
                                   daynum_bins[14],
                                   ifelse(daynum>=(daynum_bins[15]-3.5)&
                                     daynum<(daynum_bins[16]-3.5),
                                   daynum_bins[15], daynum_bins[16])
                                   )))))))))))))))
HL_cyanos2<- HL_cyanos2[-c(1,11),] #remove the duplicate records
```

Observed dates assigned into closest expected dates.  

# Step 5. Merge, check for NAs, interpolate missing data values as needed:

```{r}
### merging the two data frames ###
HL_cyanoHAB<- merge(HL_Chl2, HL_cyanos2, by=c("Yr", "daynum_bin"),
                    all=TRUE)

### check for NAs and linearly approximate to fill data gaps ###
summary(HL_cyanoHAB$Chla_ugL) #check for NAs
HL_cyanoHAB$Chla_ugL<- na.approx(HL_cyanoHAB$Chla_ugL) #interpolates NAs
summary(HL_cyanoHAB$Chla_ugL) #check for NAs
summary(HL_cyanoHAB$CD_cellsmL) #check for NAs
#HL_cyanoHAB$CD_cellsmL<- na.approx(HL_cyanoHAB$CD_cellsmL) #interpolates NAs
```

Missing values interpolated.

# Step 6. Save as new data file:

```{r}
write.csv(HL_cyanoHAB, file="Cleaned_data/cyanoHAB_severity.csv")
```
