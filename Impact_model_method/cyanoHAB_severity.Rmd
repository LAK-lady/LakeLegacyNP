---
title: "cyanoHAB_severity.Rmd"
author: "Lauren A. Knose, ORISE-EPA"
date: '2024-03-26'
output: html_document
editor_options: 
  chunk_output_type: console
---

The following text and code documents how algal data was processed and analyzed.
Data was also converted to time series.

# Step 1. Load dependent packages and data:

a) loading the dependent packages...

```{r}
library(ggplot2) #needed for plots
library(ggbreak) #needed for plot scale breaks
library(dplyr) #needed for reshaping/reformating data
library(plotly) #needed for 3D plots
library(zoo) #needed for NA approx function
library(reshape2) #needed to reshape data tables long to wide
```

Packages loaded.

b) loading the chlorophyll-a data...

```{r}
Chl<- read.csv(file="Original_data/EFL_chem.csv", header=TRUE) #has chl data
```

Chlorophyll-a data loaded. 

c) loading the phytoplankton data...

```{r}
phyto<-read.csv(file="Original_data/EFL_phytoplankton.csv", header=TRUE) #has the phytoplankton community dataset
```

Phytoplankton community data loaded. 

d) loading the Secchi depth data...

```{r}
Secchi<- read.csv(file="Original_data/EFL_Secchi.csv") #has Secchi depth data
```

# Step 2. Define and filter data:

a) defining and filtering data for total algal biomass (as Chl-a)...

```{r}
Chl<- reshape(Chl, idvar=c("Date", "depth_ft"), 
               timevar="Analyte", 
               direction="wide") #reshape to wide
EFL_Chl<- Chl %>%
  mutate(sampledate=as.Date(Date, format="%m/%d/%Y", 
                            origin="1899-12-30"), #tells R to format field as Date
         Chla_ugL=Value.CHLA,
         Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j"))) %>% #renames field to common name
  filter(!is.na(Chla_ugL)) %>% #removes NAs in chl-a data
  select(sampledate, Yr, Chla_ugL, daynum) #selects only fields of interest
```

Chl-a data defined and filtered. 

b) defining and filtering data for cyanobacteria density (CD)...

```{r}
EFL_cyanoRB<- phyto %>%
  mutate(sampledate=as.Date(Collection_Date, format="%m/%d/%Y",
                            origin="1899-12-30"),
         CD_cellsmL=as.numeric(TaxaSpecific_Cell_Density_cellsmL)) %>% #tells R to format field as Datey
  filter(SiteID=="BUO", #filter for Lake Mendota data
         Division=="Cyanobacteria") %>% #filter for cyanobacteria data
  select(sampledate, Depth_ft, CD_cellsmL) %>% 
  group_by(sampledate) %>% #group all observations by sample date
  summarize(CD_cellsmL=sum(CD_cellsmL, na.rm=TRUE)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j")))  #adds field with day
```

CD data defined and filtered.

c) defining and filtering the Secchi depth data...

```{r}
in_m<- 1*0.0254 #conversion factor from inches to meters
EFL_Secchi<- Secchi %>%
  mutate(sampledate=as.Date(Date, format="%m/%d/%Y",
                            origin="1899-12-30")) %>% #tells R to format field as Date
  filter(id=="EFL", depth_ft==0) %>%  #filter for specific site and depth
  select(sampledate, Analyte, Value) #select fields needed
EFL_Secchi<- reshape(EFL_Secchi, idvar=c("sampledate"), 
               timevar="Analyte", 
               direction="wide") #reshape to wide
EFL_Secchi <- EFL_Secchi %>%
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #adds field with year
         daynum=as.numeric(format(sampledate, "%j")), #adds field with day
         Secchi_m=as.numeric(Value.Secchi*in_m),#adds field with Secchi in m
         Value.Secchi=NULL) #remove extra field
```

# Step 3. View the data available:

a) Plotting Chl-a data available...

```{r}
ggplot(data=EFL_Chl, aes(x=sampledate, y=Chla_ugL)) + #plots Chl-a across date
  geom_point() + #adds points at observations
  geom_line() + #adds lines between 
  theme_classic(base_size=12) +
  labs(x="Date", y="Total Chl-a (ug/L)")
ggplot(data=EFL_Chl, #create limno plot with depth inverse on y-axis
       aes(x=daynum, #sampled date as x-axis
           y=Chla_ugL,
           color=Chla_ugL)) + #and data points colored by temperature
  geom_point() + #plot points
  facet_wrap(~Yr) + #make separate plot for each year
  theme_classic() +
  labs(x="Day of Year", y="Chl-a (ug/L)") 
```

Chl-a data plotted. Chl-a available from 2008 to 2012, note NAs in 2017.

b) Plotting CD data available...

```{r}
ggplot(data=subset(EFL_cyanoRB, Yr>=2015), aes(x=sampledate, y=CD_cellsmL/1000))+
  geom_point() +  #point plot 
  geom_line() + #lines between points
  theme_classic(base_size=12)+
  labs(x="Date", y="Cyanobacteria Density (10^3 cells/mL)")

ggplot(data=EFL_cyanoRB, #create limno plot with depth inverse on y-axis
       aes(x=daynum, #sampled date as x-axis
           y=CD_cellsmL,
           color=CD_cellsmL)) + #and data points colored by temperature
  geom_point() + #plot points
  facet_wrap(~Yr) + #make separate plot for each year
  theme_classic() +
  labs(x="Day of Year", y="Cyano Density (cells/mL)") 
  
```

CRB and CD data plotted. 

c) plotting Secchi depth and cyanobacteria relative biovolume to get cyanoHAB
season...

```{r}
EFL_Secchi_fig<- EFL_Secchi %>%
  select(sampledate, Secchi_m) #select fields of interest
EFL_cyanoRB_fig<- EFL_cyanoRB %>%
  select(sampledate, CD_cellsmL) #selects fields of interest
Figure_data<- merge(EFL_Secchi_fig, EFL_cyanoRB_fig, by=c("sampledate"),
                       all=TRUE) #merges data frames and keeps all records
Figure_data<- Figure_data %>%
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #adds field with year
         daynum=as.numeric(format(sampledate, "%j")))

a <- ggplot(data=Figure_data, aes(x=daynum, y=Secchi_m)) + #plots SD across day
  geom_point() + #plots observations as points
  theme_classic(base_size=12) +
  geom_smooth() + #adds regression curve
  labs(x="Day of year", y="Secchi depth (m)") 
#  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
#           xmin=-Inf, xmax=196, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
#  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
#           xmin=258, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
b <- ggplot(data=Figure_data, aes(x=daynum, y=CD_cellsmL)) + #plots cyano RB across day
  geom_point() + #plots observations as points
  theme_classic(base_size=12) +
  geom_smooth() + #adds regression curve
  labs(x="Day of year", 
       y="Cyanobacteria density (cells/mL))") 
#  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
#           xmin=-Inf, xmax=196, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
#  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
#           xmin=258, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
fig<- a / b #plot a over plot b
fig #print out plot
```

Data plotted.

# Step 4. Bin observations into same daynumber each year:

a) defining expected observation frequencies...
```{r}
Yr<- seq(from=2015, #define year start of study period
             to=2017, #define year end of study period
             by=1) #creates a sequence every 1 year
Yr
daynum_bins<- seq(from=181, #define date start of CyanoHAB season
                  to=245, #define date end of CyanoHAB season
                  by=1) #creates a sequence every 1 day 
daynum_bins #prints the expected observation dates of data
EFL_phyto<- data.frame(Yr=rep(Yr, each=65),  #create data frame with expected yr
                       daynum_bin=rep(daynum_bins, times=3)) #and day number
EFL_phyto #prints data frame
```

Defined expected observation frequency.

Observed dates assigned to closest expected dates.

c) merging the data frames...
Note, R only merges two data frames at one time.

```{r}
EFL_Chl_3yr<- EFL_Chl %>%
  filter(Yr>=2015 & Yr <=2017) #filters data for target years
EFL_cyanoRB_3yr<- EFL_cyanoRB %>%
  filter(Yr>=2015 & Yr <=2017) #filters data for target years

EFL_phyto<- merge(EFL_phyto, #x data frame
                 EFL_Chl_3yr, #y data frame
                 by.x=c("Yr","daynum_bin"),
                 by.y=c("Yr","daynum"),
                 all.x=TRUE) #define the key fields
EFL_phyto<- merge(EFL_phyto, #x data frame
                 EFL_cyanoRB_3yr, #y data frame
                 by.x=c("Yr","daynum_bin"),
                 by.y=c("Yr","daynum"),
                 all.x=TRUE) #define the key fields
```

Data merged.

# Step 5. Check for NAs, interpolate missing data values as needed:

```{r}
EFL_phyto2<- EFL_phyto[1:186, ] #remove last NA's
EFL_phyto2$Chla_ugL<- na.approx(EFL_phyto2$Chla_ugL) #interpolates NAs
EFL_phyto2$CD_cellsmL<- na.approx(EFL_phyto2$CD_cellsmL) #interpolates NAs
```

Missing values interpolated.

# Step 6. Save as new data file:

```{r}
write.csv(EFL_phyto2, file="Cleaned_data/cyanoHAB_severity_EFL.csv")
```
