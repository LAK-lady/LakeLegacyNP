---
title: "cyanoHAB_season"
author: "Lauren Knose"
date: "2024-05-23"
output: html_document
editor_options: 
  chunk_output_type: console
---

The purpose of this program is to define the cyanoHAB season of the lake. Two variables are needed for this program, Secchi disk depth and phytoplankton cell counts. 

# Step 1. Load dependent packages and data:

a) loading the dependent packages...

```{r}
library(dplyr) #needed for reshaping/reformating data
library(ggplot2) #needed for plots
library(reshape2) #needed for reformatting data frames
library(ggpubr) #needed to plot mupltiple plots together
```

Packages loaded.

b) loading the data...

```{r}
### load the Secchi disk depth data ###
Secchi<- read.csv(file="Cleaned_data/HarshaLake_secchi.csv")

### load the phytoplankton cell count data ###
phyto<-read.csv(file="Cleaned_data/HarshaLake_phytoplankton.csv")

### load the chlorophyll-a data ###
Chl<- read.csv(file="Original_data/HarshaLake_Chla.csv", header=TRUE) #has chl data
```

Data loaded.

# Step 2. Reformat and filter data:

a) reformatting and filtering data for cyanobacteria relative biovolume (CRB) and cyanobacteria density (CD)...

```{r}
### identify the labels used for fields ###
colnames(phyto) #identify labels for fields to filter
unique(phyto$SiteID) #determine the label for the site
unique(phyto$Division) #determine the label for cyanobacteria
head(phyto$CollectionDate) #determine format for sample date
min(phyto$CollectionDate) #earliest sample date
max(phyto$CollectionDate) #latest sample date
sort(unique(phyto$Depth_ft)) #determine the depths data were collected
summary(phyto$SampleSpecificCellRelativeAbundance_Perc)
summary(phyto$TaxaSpecificCellDensity_cellsmL)

### Site 1: BUO ###
BUO_cyanos<- phyto %>%
  mutate(sampledate=as.Date(CollectionDate,
                            format="%m/%d/%Y",
                            origin="1899-12-30")) %>% #tells R field contains dates
  filter(SiteID=="BUO", #filter for buoy site data
         Division=="Cyanobacteria"|Division==" Cyanobacteria ") %>% #filter for cyanobacteria 
  group_by(sampledate) %>% #group all observations by sample date
  summarize(cyano_relabund=sum(SampleSpecificCellRelativeAbundance_Perc), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(TaxaSpecificCellDensity_cellsmL)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(cyano_relabund<=100) %>% #remove any invalid records (>100%  not valid entry)
  ungroup()
write.csv(BUO_cyanos, file="Cleaned_data/HarshaLake_BUO_cyanos.csv")

### Site 2: EFL ###
EFL_cyanos<- phyto %>%
  mutate(sampledate=as.Date(CollectionDate,
                            format="%m/%d/%Y",
                            origin="1899-12-30")) %>% #tells R field contains dates
  filter(SiteID=="EFL", #filter for buoy site data
         Division=="Cyanobacteria"|Division==" Cyanobacteria ") %>% #filter for cyanobacteria data
  group_by(sampledate) %>% #group all observations by sample date
  summarize(cyano_relabund=sum(SampleSpecificCellRelativeAbundance_Perc), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(TaxaSpecificCellDensity_cellsmL)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(cyano_relabund<=100) %>% #remove any invalid records (>100%  not valid entry)
  ungroup()
write.csv(BUO_cyanos, file="Cleaned_data/HarshaLake_EFL_cyanos.csv")

### Site 3: EMB ###
EMB_cyanos<- phyto %>%
  mutate(sampledate=as.Date(CollectionDate,
                            format="%m/%d/%Y",
                            origin="1899-12-30")) %>% #tells R field contains dates
  filter(SiteID=="EMB", #filter for buoy site data
         Division=="Cyanobacteria"|Division==" Cyanobacteria ") %>% #filter for cyanobacteria data
  group_by(sampledate) %>% #group all observations by sample date
  summarize(cyano_relabund=sum(SampleSpecificCellRelativeAbundance_Perc), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(TaxaSpecificCellDensity_cellsmL)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(cyano_relabund<=100) %>% #remove any invalid records (>100%  not valid entry)
  ungroup()
write.csv(BUO_cyanos, file="Cleaned_data/HarshaLake_EMB_cyanos.csv")

### Site 4: ENN ###
ENN_cyanos<- phyto %>%
  mutate(sampledate=as.Date(CollectionDate,
                            format="%m/%d/%Y",
                            origin="1899-12-30")) %>% #tells R field contains dates
  filter(SiteID=="ENN", #filter for buoy site data
         Division=="Cyanobacteria"|Division==" Cyanobacteria ") %>% #filter for cyanobacteria data
  group_by(sampledate) %>% #group all observations by sample date
  summarize(cyano_relabund=sum(SampleSpecificCellRelativeAbundance_Perc), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(TaxaSpecificCellDensity_cellsmL)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(cyano_relabund<=100) %>% #remove any invalid records (>100%  not valid entry)
  ungroup()
write.csv(BUO_cyanos, file="Cleaned_data/HarshaLake_ENN_cyanos.csv")
```

CRB and CD data formatted.

b) reformatting and filtering data for Secchi depth...

```{r}
### identify the labels used for fields ###
colnames(Secchi) #identify labels for fields to filter
unique(Secchi$SiteID) #determine the label for the site
head(Secchi$SampleDate) #determine format for sample date
unique(Secchi$Variable)
unique(Secchi$Unit)
in_m <- 0.0254 #conversion factor from inch to meter

### Site 1: BUO ###
BUO_Secchi<- Secchi %>%
  mutate(sampledate=as.Date(SampleDate,
                            format="%m/%d/%Y",
                            origin="1899-12-30"),#tells R to format field as Date
         SD_m=Value*in_m) %>% #adds units to field
  filter(SiteID=="BUO") #filter for the two sample sites

### Site 2: EFL ###
EFL_Secchi<- Secchi %>%
  mutate(sampledate=as.Date(SampleDate,
                            format="%m/%d/%Y",
                            origin="1899-12-30"),#tells R to format field as Date
         SD_m=Value*in_m) %>% #adds units to field
  filter(SiteID=="EFL") #filter for the two sample sites

### Site 3: EMB ###
EMB_Secchi<- Secchi %>%
  mutate(sampledate=as.Date(SampleDate,
                            format="%m/%d/%Y",
                            origin="1899-12-30"),#tells R to format field as Date
         SD_m=Value*in_m) %>% #adds units to field
  filter(SiteID=="EMB")  #filter for the two sample sites

### Site 4: ENN ###
ENN_Secchi<- Secchi %>%
  mutate(sampledate=as.Date(SampleDate,
                            format="%m/%d/%Y",
                            origin="1899-12-30"),#tells R to format field as Date
         SD_m=Value*in_m) %>% #adds units to field
  filter(SiteID=="ENN")  #filter for the two sample sites
```

Secchi data formated.

c) merging the data...
```{r}
cyanos<- phyto %>%
  mutate(sampledate=as.Date(CollectionDate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30")) %>% #tells R field contains dates
  filter(Division=="Cyanobacteria"|Division==" Cyanobacteria ") %>% #filter for cyanobacteria data
  group_by(SiteID, sampledate) %>% #group all observations by sample date
  summarize(cyano_relabund=sum(SampleSpecificCellRelativeAbundance_Perc), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(TaxaSpecificCellDensity_cellsmL)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(cyano_relabund<=100) %>% #remove any invalid records (>100%  not valid entry)
  ungroup()

Secchi2<- Secchi %>%
  mutate(sampledate=as.Date(SampleDate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30"),#tells R to format field as Date
         SD_m=Value*in_m, #add units to field
         Value=NULL, Unit=NULL, Variable=NULL, SampleDate=NULL) #remove extra fields
  

cyanoHAB_season<- merge(cyanos, Secchi2, by=c("SiteID", "sampledate"),
                       all =TRUE) #merges data frames and keeps all records 
cyanoHAB_season<- cyanoHAB_season %>%
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j"))) #adds field with day
```

Data merged.

# Step 3. View the data available:

a)  plotting Secchi depth and cyanobacteria relative biovolume to get cyanoHAB season for each site...

```{r}
### plot Secchi depth by day of year ###
a<- ggplot(data=cyanoHAB_season, aes(x=daynum, y=SD_m)) + #plots SD across day
  geom_point() + #plots observations as points
  theme_classic(base_size=12) +
  facet_wrap(~SiteID) +
  geom_smooth() + #adds regression curve
  geom_vline(xintercept = 160, lty="dashed")+ #add line for June 15th
  labs(x="Day of year", y="Secchi depth (m)") +
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=152, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=288, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
a

### plot cyanobacteria relative biovolume by day of year ###
b <- ggplot(data=cyanoHAB_season, aes(x=daynum, y=cyano_relabund)) + #plots cyano RB across day
  geom_point() + #plots observations as points
  theme_classic(base_size=12) +
  facet_wrap(~SiteID) +
  geom_vline(xintercept = 190, lty="dashed")+ #add line for June 15th
  geom_smooth() + #adds regression curve
  labs(x="Day of year", 
       y="Cyanobacteria relative abundance 
       (% of total)") +
  geom_hline(yintercept=50, lty="dashed")+
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=152, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=288, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
b

c<- ggplot(data=cyanoHAB_season, aes(x=daynum, y=CD_cellsmL)) + #plots cyano RB across day
  geom_point() + #plots observations as points
  theme_classic(base_size=12) +
  facet_wrap(~SiteID) +
  geom_vline(xintercept = 184, lty="dashed")+ #add line for June 15th
  geom_smooth() + #adds regression curve
  labs(x="Day of year", 
       y="Cyanobacteria Cell Density 
       (cells/mL)") +
  ylim(0,1000000)+
  geom_hline(yintercept=50, lty="dashed")+
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=152, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=288, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
c
```

Cyanobacteria plotted.
