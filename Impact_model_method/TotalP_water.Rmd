---
title: "TotalP_water.Rmd"
author: "Lauren A. Knose, ORISE-EPA"
date: '2024-03-27'
output: html_document
editor_options: 
  chunk_output_type: console
---

The purpose of this program is to isolate phosphorus measurements in the surface 
water (epilimnion) and bottom water (hypolimnion) of the lake. 

# Step 1. load dependent packages and data needed:

a) Loading the dependent packages...

```{r}
library(dplyr) #needed for transforming data
library(ggplot2) #needed for plotting
library(plotly) #needed for interactive 3D plot
library(orca) #needed to save 3D image
```

Packages loaded.

b) Loading the data...

```{r}
data<- read.csv(file="Original_data/EFL_chem.csv", header=TRUE) #has nutrient data measured in lake
```

# Step 2. Transform and filter data:

a) filter and transform data from EFL...

```{r}
ft_m <- 0.3048 #conversion factor from feet to m
ug_mg<- 1/1000 #conversion factor from ug to mg
EFL_totP<- data %>%
  filter(Analyte=="TP") %>% #filter for total P
  mutate(sampledate=as.Date(Date, format="%m/%d/%Y",
                            origin="1899-12-30"), #format as Date
         Depth_m = depth_ft*ft_m) %>% #rename depth field with units (meters)
  select(sampledate, Depth_m, Analyte, Value) 
EFL_totP<- reshape(EFL_totP, idvar=c("sampledate", "Depth_m"), 
               timevar="Analyte", 
               direction="wide") #reshape to wide
EFL_totP<- EFL_totP %>%
  mutate(TotP_mgL=Value.TP*ug_mg, #rename field
         Value.TP=NULL,
         Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j"))) %>% #remove extra field
  filter(!is.na(TotP_mgL)) #remove records with NAs
  
stem(EFL_totP$Depth_m) #plots the number of observations by depth (y-axis)
sort(unique(EFL_totP$Depth_m)) #identify the depths of measurements
```

b) Filter and transform epilimnion P data...
```{r}
Epi_P<- EFL_totP %>%
  filter(Depth_m < 8) %>% #for observations taken at or above 8 m
  group_by(sampledate) %>% #group all observations in same sample date
  summarize(TotP_mgL=mean(TotP_mgL, na.rm=TRUE)) #calculates mean for all depths in epi 

date_range<- seq( #creates a vector of sequence data
  min(Epi_P$sampledate), #starting at the first sample date
  max(Epi_P$sampledate), #ending at the last sample date
  by="1 day") #observations every day  
interpolated<- approx( #creates a vector of data that linearly interpolates 
  Epi_P$sampledate, #across date
  Epi_P$TotP_mgL, #the predicted values of epi total P 
  xout=date_range) #for every 1 day
epiP_interp <- data.frame( #creates a new data frame that has 
  sampledate = as.Date(interpolated$x), #measurements every 14 days
                             TotP_mgL=interpolated$y) #predicted hypo: epi P ratio
plot(epiP_interp,
     xlab="Date",
     ylab="Total P concentration (mg/L)",
     main="Epilimnion") #plots the new time series
```

Epi P data transformed and filtered.

c) Filter and transform hypolimnion P data...

```{r}
Hypo_P<- EFL_totP %>%
  filter(Depth_m >= 14) %>% #for observations taken at or below 20 m
  group_by(sampledate) %>% #group all observations in same sample date
  summarize(TotP_mgL=mean(TotP_mgL, na.rm=TRUE)) #calculates mean for all depths in hypo

date_range<- seq( #creates a vector of sequence data
  min(Hypo_P$sampledate), #starting at the first sample date
  max(Hypo_P$sampledate), #ending at the last sample date
  by="1 day") #observations every day  
interpolated<- approx( #creates a vector of data that linearly interpolates 
  Hypo_P$sampledate, #across date
  Hypo_P$TotP_mgL, #the predicted values of epi total P 
  xout=date_range) #for every 1 day
hypoP_interp <- data.frame( #creates a new data frame that has 
  sampledate = as.Date(interpolated$x), #measurements every 14 days
                             TotP_mgL=interpolated$y) #predicted hypo: epi P ratio
plot(hypoP_interp,
     xlab="Date",
     ylab="Total P concentration (mg/L)",
     main="Hypolimnion") #plots the new time series

```

Hypo P data transformed and filtered.

# Step 3. Combine epi and hypo data into single data file, calculate hypo: epi 
total P ratio:

```{r}
EFL_P_water<- merge(epiP_interp, hypoP_interp, by="sampledate") #merge the epi and hypo P by sample date
EFL_P_water<- EFL_P_water %>% #need to clean up 
  mutate(Epi_TotP_mgL=TotP_mgL.x, #rename column
         TotP_mgL.x=NULL, #remove duplicate column
         Hypo_TotP_mgL=TotP_mgL.y,#rename column
         TotP_mgL.y=NULL,#remove duplicate column
         HE_ratio_TotP_mgL=Hypo_TotP_mgL/Epi_TotP_mgL, #calculate Hypo: Epi total P
         Yr=as.integer(format(sampledate, "%Y")), #adds field with year
         MoYr=format(sampledate, "%m/01/%Y"), #adds field with month and year
         daynum=as.integer(format(sampledate, "%j")), #adds field with Julian date
         Mo=as.integer(format(sampledate, "%m"))) #adds field with month)
```

# Step 4. Summarize and view the data:

a) Plotting epi P data...

```{r}
ggplot(data=EFL_P_water, 
       aes(x=daynum,y=Epi_TotP_mgL)) + 
  geom_point(aes(shape=as.factor(Yr)))+
  labs(title="Epilimnion (<8m), East Fork Lake", #plot title
       x="Day of Year", #x axis label
       y="Total Phosphorus Concentration (mg/L)", #y axis label
       shape="Year",
       caption="White highlight indicates CyanoHAB season.
       Red dashed line indicates moving-average regression.") + 
  ylim(0, max(EFL_P_water$Epi_TotP_mgL)) +
  scale_x_continuous(breaks = seq(0, max(EFL_P_water$daynum), #places axis tick marks
                                  by=30)) + #every 30 days (1 month) - CHANGE AS
  # NEEDED
  theme_classic()+
  #scale_color_continuous(name="Year")+
  geom_smooth(col="darkred", lty="dashed") + #adds loess curve (moving average regression model)
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=188, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=238, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
```

Epi data plotted.

b) Plotting hypo P data...

```{r}
ggplot(data=subset(EFL_P_water, Yr>=2012), 
       aes(x=daynum,y=Hypo_TotP_mgL)) + 
  geom_point(aes(shape=as.factor(Yr)))+
  labs(title="Hypolimnion (>14m), East Fork Lake", #plot title
       x="Day of Year", #x axis label
       y="TOtal Phosphorus Concentration (mg/L)", #y axis label
       shape="Year",
       caption="White highlight indicates CyanoHAB season.
       Red dashed line indicates moving-average regression.") + 
  ylim(0, max(EFL_P_water$Hypo_TotP_mgL)) +
  scale_x_continuous(breaks = seq(0, max(EFL_P_water$daynum), #places axis tick marks
                                  by=30)) + #every 30 days (1 month) - CHANGE AS
  # NEEDED
  theme_classic()+
  #scale_color_continuous(name="Year")+ changed to factor no longer color
  geom_smooth(col="darkred", lty="dashed") + #adds loess curve (moving average regression model)
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=188, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=238, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
```

c) Plotting hypo: epi total P...

```{r}
EFL_P_ratio <- EFL_P_water %>%
  select(Yr, daynum, HE_ratio_TotP_mgL) #select only the 

fig<- plot_ly(x=EFL_P_ratio$Yr, #creates 3D plot with year as x axis
               y=EFL_P_ratio$daynum, #day of year as y axis
               z=EFL_P_ratio$HE_ratio_TotP_mgL, #P_hypo:P_epi as z axis
               type="scatter3d", mode="markers", #values as points
               color=EFL_P_ratio$HE_ratio_TotP_mgL) %>% #colors points by value
  layout(scene=list(xaxis=list(title="Year", tickfont=list(size=12)),
                    yaxis=list(title="Day of Year", tickfont=list(size=12)),
                    zaxis=list(title="Total P hypo:epi", tickfont=list(size=12))
                    )
         ) 
fig #save image mannually
```

# Step 5. Save the new data file:

```{r}
write.csv(EFL_P_ratio, file="Cleaned_data/TotalP_water_EFL.csv")
```