---
title: "cyanoHAB_severity.Rmd"
author: "Lauren A. Knose, ORISE-EPA"
date: '2024-06-10'
output: html_document
editor_options: 
  chunk_output_type: console
---

The following text and code documents how algal data was processed and analyzed.
Data was also converted to time series.

# Step 1. Load dependent packages and data:

a) loading the dependent packages...

```{r}
library(ggplot2) #needed for plots
library(dplyr) #needed for reshaping/reformating data
library(ggpubr) #needed for graphing multiple plots
library(zoo) #needed for na aggregate
```

Packages loaded.

b) loading the data...

```{r}
### load phytoplankton cell count data ###
phyto<-read.csv(file="Cleaned_data/HarshaLake_cyanos.csv", header=TRUE) #has the phytoplankton community dataset

### load chlorophyll-a data ###
Chl<- read.csv(file="Original_data/HarshaLake_Chla.csv", header=TRUE) #has chl data

toxins<- read.csv(file="Original_data/ODOH_HarshaLake_toxinresults_2011to2024.csv", header=TRUE)
```

Data loaded. 

# Step 2. Calculate cyanobacteria cell density (CD):

a) reformatting and filtering the CD data...

```{r}
### reformatting and summarizing phyto data ###
cyanos<- phyto %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30")) %>% #tells R to format field as Date
  group_by(SiteID, sampledate) %>%
  summarize(avgCD_cellsmL=mean(CD_cellsmL, na.rm=TRUE),
            avgcyano_relbiovol=mean(cyano_relbiovol, na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j")))
```

CD reformatted and filtered.

b) reformatting and filtering chl-a data...

```{r}
### identify labels used for fields ###
colnames(Chl)
unique(Chl$id)
sort(unique(Chl$depth_ft))
unique(Chl$Analyte)

### add conversion factors ###
ft_m<- 0.3048# conversion factor from feet to m

### reformatting and filtering chl-a data ###
chla<- Chl %>%
  filter(id=="EOF"|id=="BUO"|id=="EMB"|id=="ENN"|id=="ECP") %>%
  mutate(sampledate=as.Date(Date, origin="1899-12-30", format="%m/%d/%Y")) %>% #tells R to format field as Date
  rename(Chla_ugL= Value,
         SiteID=id) %>% #renames field to common name with units)
  mutate(Depth_m=depth_ft*ft_m) %>% # convert depth from feet to meters
  filter(!is.na(Chla_ugL)) %>% #removes NAs in chl-a data
  select(SiteID, sampledate, Chla_ugL, Depth_m) %>% #selects only fields of interest
  filter(Chla_ugL>=0 & Chla_ugL<=1000) #realistic parameters

### calculate average Chla for epi ###
hist(chla$Depth_m)
HL_chla<- chla %>%
  group_by(SiteID, sampledate) %>%
  filter(Depth_m<=5) %>% #filter for epilimnion
  summarise(avgChla_ugL=mean(Chla_ugL, na.rm=TRUE)) %>%
  ungroup() %>%
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j")))   #renames field to)
```

Chla reformatted and filtered.

c) reformatting and filtering the toxin data...

```{r}
### identify labels used for fields ###
colnames(toxins)
unique(toxins$Analyte) 
unique(toxins$Units) #check units
unique(toxins$Site)

HL_tox<- toxins %>%
  mutate(sampledate=as.Date(Sample_date, origin="1899-12-30",
                            format="%m/%d/%Y")) %>% #tells R to format field as Date
  filter(Analyte=="Microcystin") %>% #filter for toxin of interest
  rename(Microcystin_ugL=Value, #rename field
         SiteID=Site) %>% #renames field to common name with units)
```

Toxin data reformatted and filtered.

# Step 3. View the data available:

a) plotting Chl-a data available...

```{r}
### filter data to cyanoHAB season ###
fig3a_data<- HL_chla %>%
  filter(daynum>=152 & daynum<=258)

### plot cyanoHAB severity as chl-a over time ###
SI_fig3a<- ggplot(data=fig3a_data, aes(x=daynum, y=avgChla_ugL, color=Yr)) + #plots Chl-a across date
  geom_point() + #adds points at observations
  facet_wrap(~SiteID) +
  theme_classic(base_size=12) +
  labs(x="Day of Year", y="Total Chl-a (ug/L)", title="a)") +
  annotate('rect', xmin=min(fig3a_data$daynum), xmax=max(fig3a_data$daynum),
           ymin=0, ymax=12, alpha=.2, fill='green') + #low/no CyanoHAB
  annotate('rect', xmin=min(fig3a_data$daynum), xmax=max(fig3a_data$daynum),
           ymin=12, ymax=50, alpha=.2, fill='orange')+ #moderate CyanoHAB
  annotate('rect', xmin=min(fig3a_data$daynum), xmax=max(fig3a_data$daynum),
           ymin=50, ymax=Inf, alpha=.2, fill='red') #severe CyanoHAB
SI_fig3a
```

Chl-a data plotted. 

b) Plotting CD data available...

```{r}
### filter data to cyanoHAB season ###
fig3b_data<- cyanos %>%
  filter(daynum>=152 & daynum<=258) #day num +- 7 days

### plot cyanoHAB severity as CD over time ###
SI_fig3b<- ggplot(data=fig3b_data, aes(x=daynum, y=avgCD_cellsmL, color=Yr))+
  geom_point() +  #point plot 
  facet_wrap(~SiteID) + #by year
  theme_classic(base_size=12)+
  scale_y_continuous(trans="log10") +
  annotate('rect', xmin=min(fig3b_data$daynum), xmax=max(fig3b_data$daynum),
           ymin=0, ymax=20000, alpha=.2, fill='green') + #low/no CyanoHAB
  annotate('rect', xmin=min(fig3b_data$daynum), xmax=max(fig3b_data$daynum),
           ymin=20000, ymax=100000, alpha=.2, fill='orange')+ #moderate CyanoHAB
  annotate('rect', xmin=min(fig3b_data$daynum), xmax=max(fig3b_data$daynum),
           ymin=100000, ymax=Inf, alpha=.2, fill='red') +#severe CyanoHAB
  labs(x="Day of Year", y="log10(Cyanobacteria Density) (cells/mL)", title="b)")
SI_fig3b #print image
```


c) plotting chla and CD together...

```{r}
SI_fig3<- ggarrange(SI_fig3a, SI_fig3b, ncol=2, nrow=1, widths=c(0.5, 0.5))
SI_fig3
ggsave("Products/SI_figures/Figure3_color.png") #saves plot to Products folder
```

Chla and CD data plotted. 

d) merging the data files...
```{r}
### merge data files ###
Chla_CD<- merge(HL_chla, cyanos, by.x=c("SiteID", "sampledate", "Yr", "daynum"), by.y=c("SiteID", "sampledate", "Yr", "daynum"), all=TRUE) 
```

Data files merged.



####################################
Does Chl-a and CD correlate?

```{r}
### plotting distributions ###
par(mfrow=c(2,2))
hist(Chla_CD$avgChla_ugL, breaks=18,#histograph of Chl-a
     main="non-transformed",
     xlab="Chl-a (ug/L)") 
hist(Chla_CD$avgCD_cellsmL, breaks=18,#histograph of CD
     main="non-transformed",
     xlab="CD (cells/mL)") 
hist(log10(Chla_CD$avgChla_ugL), breaks=18,#histograph of Chl-a
     main="log10-transformed",
     xlab="Chl-a (ug/L)") 
hist(log10(Chla_CD$avgCD_cellsmL), breaks=18,#histograph of CD
     main="log-10-transformed",
     xlab="CD (cells/mL)") 
par(mfrow=c(1,1))

#### plot regression ###
Chla_CD_plot<- ggplot(Chla_CD, aes(x=log10(avgCD_cellsmL), y=log10(avgChla_ugL))) +
  geom_point() +
#  facet_wrap(~SiteID) +
  theme_classic() +
  geom_smooth() +
  labs(x="log10(avg CD) (cells/mL)", y="log10(Chl-a) ug/L)")
Chla_CD_plot
regChlaCD<- lm(data=Chla_CD,
               formula=log10(avgCD_cellsmL)~log10(avgChla_ugL))
summary(regChlaCD)
```

Do blooms occur at same time?

```{r}
blooms<- ggplot(subset(Chla_CD, Yr>=2010), aes(x=daynum, y=avgChla_ugL))+
  geom_point() +
  geom_line() +
  theme_classic() +
  facet_wrap(~SiteID) +
  geom_vline(xintercept=200, lty="dashed", col="red") +
  scale_y_continuous(trans="log10") +
  labs(x="Day of Year (Year >= 2010)", y="log10(mean CD) (cells/mL)")
blooms
```

###################


# Step 4. Bin observations into expected frequencies:

a) defining expected observation frequencies...

```{r}
### define the number of observation years ###
Yr<- seq(from=2013, #define year start of study period
             to=2018, #define year end of study period
             by=7) #creates a sequence every 1 year
Yr #prints the expected years of data

### define the observation frequency ###
daynum_bins<- seq(from=196, #define date start of CyanoHAB season
                  to=252, #define date end of CyanoHAB season
                  by=14) #creates a sequence every 14 days 
daynum_bins #prints the expected observation dates of data

### create data frame with expected observations ###
cyanoHAB_bins<- data.frame(Yr=rep(Yr, each=5), #repeat Yr for every daynum 
                           daynum_bin=rep(daynum_bins, times=6)) #repeat daynum for every year
```

Defined expected observation frequency.

b) binning observed dates into expected dates...

```{r}
Chla_CD <- Chla_CD  %>%
  filter(daynum>= 189 & daynum<= 259) %>% #filter for cyanoHAB season
  mutate(daynum_bin=
         ifelse(daynum<(daynum_bins[2]-7), #if observation is <= bin 2 min
                daynum_bins[1], #yes returns bin 1
                ifelse(daynum>=(daynum_bins[2]-7)&daynum<(daynum_bins[3]-7),
              #if observation is > bin 2 min and <= bin 3 min
              daynum_bins[2], #yes returns bin 2
              ifelse(daynum>=(daynum_bins[3]-7)&daynum<(daynum_bins[4]-7),
                     #if observation is > bin 3 min and <= bin 4 min
                     daynum_bins[3], #yes returns bin 3
                     ifelse(daynum>=(daynum_bins[4]-7)&daynum<(daynum_bins[5]-7),
                            #if observation is > bin 4 min and <= bin 5 min 
                            daynum_bins[4], #yes returns bin 4
                            daynum_bins[5])))))#no returns bin 5
                     
Chla_CD<- Chla_CD %>% 
  filter(!duplicated(cbind(Yr, daynum_bin), fromLast = TRUE))  #remove first duplicate
```

Observed dates assigned to closest expected dates.

c) merging the data frames with expected bins...
Note, R only merges two data frames at one time.

```{r}
cyanoHAB<- merge(cyanoHAB_bins, #x data frame
                 Chla_CD, #y data frame
                 by=c("Yr","daynum_bin"),
                 all.x=TRUE) #define the key fields
```

Data merged.

# Step 5. Check for missing values and address:

a) checking for NAs...

```{r}
### checking for NAs ###
summary(cyanoHAB)
```

3 NAs identified.

b) if NAs randomly missing, replacing with annual mean...

```{r}
### calculate annual means ###
yr_mean<- cyanoHAB %>%
  group_by(Yr) %>%
  summarize(avg_Chla=mean(Chla_ugL, na.rm=TRUE),
            se_Chla=(sd(Chla_ugL, na.rm=TRUE)/sqrt(length(Chla_ugL))), 
            avg_CD=mean(CD_cellsmL, na.rm=TRUE),
            se_CD=(sd(CD_cellsmL, na.rm=TRUE)/sqrt(length(CD_cellsmL))))
yr_mean

### fill missing values with the annual mean ###
cyanoHAB<- cyanoHAB %>%
  group_by(Yr) %>%
  mutate(across(Chla_ugL, ~na.aggregate(., FUN=mean, na.rm=FALSE)),
         across(CD_cellsmL, ~na.aggregate(., FUN=mean, na.rm=TRUE))) %>%
  ungroup()

### check that missing values replaced with means ###
summary(cyanoHAB$Chla_ugL)
summary(cyanoHAB$CD_cellsmL)
```

NAs replaced.

# Step 6. Interpolate weekly response values:

a) define expected frequencies...

```{r}
### determine expected observation frequencies ###
week_bins<- seq(from=196, #define date start of CyanoHAB season
                  to=252, #define date end of CyanoHAB season
                  by=7) #creates a sequence every week 
week_bins #prints the expected observation dates of data

### create data frame with the frequencies wanted ###
week_bins<- data.frame(Yr=rep(Yr, each=9),week_bin=rep(week_bins, times=6))
```

Expected weekly frequencies defined.

b) merging data to expected frequencies... 

```{r}
### merge observations with data frame of frequencies ###
cyanoHAB2<- merge(week_bins, cyanoHAB, by.x=c("Yr","week_bin"), 
                      by.y=c("Yr", "daynum_bin"), all=TRUE) 
```

Weekly frequencies added to observations.

c) interpolating missing daily values...

```{r}
### linearly interpolate the missing values ###
cyanoHAB_approx<- cyanoHAB2 %>%  
  group_by(Yr) %>%
  mutate(Chla_ugL=na.approx(Chla_ugL, na.rm=F, rule=2),
         CD_cellsmL=na.approx(CD_cellsmL, na.rm=F, rule=2)) %>% #interpolates where NA
  ungroup() 
```

Daily observations interpolated.

# Step 7. Add fields with lagged values:

```{r}
cyanoHAB_approx<- cyanoHAB_approx %>%
  mutate(Chla_ugL_k7=lag(Chla_ugL, n=1), 
         CD_cellsmL_k7=lag(CD_cellsmL, n=1),
         Chla_ugL_k14=lag(Chla_ugL, n=2), 
         CD_cellsmL_k14=lag(CD_cellsmL, n=2),
         Chla_ugL_k21=lag(Chla_ugL, n=3), 
         CD_cellsmL_k21=lag(CD_cellsmL, n=3),
         Chla_ugL_k28=lag(Chla_ugL, n=4), 
         CD_cellsmL_k28=lag(CD_cellsmL, n=4)) 
```

Field with lagged values added.

# Step 8. Save as new data files:

```{r}
### save the new Chla data file ###
write.csv(cyanoHAB_approx, file="Cleaned_data/cyanoHAB_severity.csv")
```
