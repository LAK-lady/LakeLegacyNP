---
title: "cyanoHAB_severity.Rmd"
author: "Lauren A. Knose, ORISE-EPA"
date: '2025-05-23'
output: html_document
editor_options: 
  chunk_output_type: console
---

The following text and code documents how algal data was processed and analyzed.
Data was also converted to time series.

# Step 1. Load dependent packages and data:

a) loading the dependent packages...

```{r}
library(ggplot2) #needed for plots
library(dplyr) #needed for reshaping/reformating data
library(plotly) #needed for 3D plots
```

Packages loaded.

b) loading the data...

```{r}
### load chlorophyll-a data ###
Chl<- read.csv(file="Original_data/ntl38_v5_chl.csv", header=TRUE) #has chl data

### load phytoplankton cell count data ###
phyto<-read.csv(file="Original_data/ntl88_v13_phytoplankton.csv", header=TRUE) #has the phytoplankton community dataset
```

Data loaded. 

# Step 2. Format and filter data:

a) Formatting and filtering data for total algal biomass (as Chl-a)...

```{r}
Me_Chl<- Chl %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30"), #tells R to format field as Date
         Chla_ugL= tri_chl_spec, #renames field to common name with units
         Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j"))) %>% #renames field to common name
  filter(lakeid=="ME", #filter for Lake Mendota data
         depth_range_m=="0-8", #filter for data from integrated samples 0 to 8m
         rep=="1",#remove QA analytic replicates
         Yr>=2012 & Yr<=2018, #filter for study period
         daynum >=189 & daynum <=265) %>% #filter for study period +- 7 days
  filter(!is.na(Chla_ugL)) %>% #removes NAs in chl-a data
  select(sampledate, Yr, Chla_ugL, daynum) #selects only fields of interest
summary(Me_Chl$Chla_ugL) #check for NAs
```

Chl-a data defined and filtered. 

b) Formatting and filtering data for cyanobacteria relative biovolume (CRB) and cyanobacteria density (CD)...

```{r}
Me_cyano<- phyto %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30"), #tells R to format field as Date
  Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j"))) %>%  #adds field with day
  filter(lakeid=="ME", #filter for Lake Mendota data
         depth_range=="0-8m", #filter for data from integrated samples 0 to 8m
         division=="Cyanophyta", #filter for cyanobacteria
         Yr>=2012 & Yr<=2018, #filter for study period
         daynum >=189 & daynum <=265) %>% #filter for study period +- 7 days) %>% #filter for cyanobacteria data
  group_by(sampledate) %>% #group all observations by sample date
  summarize(cyano_relbiovol=sum(relative_total_biovolume), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(cells_per_ml)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(cyano_relbiovol<=100) %>% #remove any invalid records (>100%  not valid entry)   
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j")))  #adds field with day
summary(Me_cyanoRB$CD_cellsmL) #check for NAs
```

CRB and CD data defined and filtered.

# Step 3. View the data available:

a) Plotting Chl-a data available...

```{r}
SI_fig3<- ggplot(data=subset(Me_Chl, Yr!=2017), aes(x=daynum, y=Chla_ugL)) + #plots Chl-a across date
  geom_point() + #adds points at observations
  geom_line() + #adds lines between 
  facet_wrap(~Yr) +
  theme_classic(base_size=12) +
  labs(x="Day of Year", y="Total Chl-a (ug/L)") +
  annotate('rect', xmin=min(Me_Chl$daynum), xmax=max(Me_Chl$daynum),
           ymin=0, ymax=12, alpha=.2, fill='green') + #low/no CyanoHAB
  annotate('rect', xmin=min(Me_Chl$daynum), xmax=max(Me_Chl$daynum),
           ymin=12, ymax=50, alpha=.2, fill='orange')+ #moderate CyanoHAB
  annotate('rect', xmin=min(Me_Chl$daynum), xmax=max(Me_Chl$daynum),
           ymin=50, ymax=Inf, alpha=.2, fill='red') #severe CyanoHAB
SI_fig3 #prints out figure
ggsave("Products/SI_figures/Figure3.png") #saves plot to Products folder
```

Chl-a data plotted. Chl-a available from 2008 to 2012.

b) Plotting CRB and CD data available...

```{r}
### plot cyanobacteri relative biovolume by sample date ###
a<- ggplot(data=Me_cyano, aes(x=sampledate, y=cyano_relbiovol))+
  geom_point() +  #point plot 
  geom_line() + #lines between points
  theme_classic(base_size=12)+
  geom_hline(yintercept=75, lty="dashed") +
  labs(x="Date", y="Cyanobacteria Relative Biovolume 
       (as % total phytoplankton biovolume)")
### plot cell density by 
b<- ggplot(data=Me_cyano, aes(x=daynum, y=CD_cellsmL))+
  geom_point() +  #point plot 
  geom_line() + #lines between points
  facet_wrap(~Yr) + #by year
  theme_classic(base_size=12)+
  scale_y_continuous(trans="log10") +
  annotate('rect', xmin=min(Me_cyano$daynum), xmax=max(Me_cyano$daynum),
           ymin=0, ymax=20000, alpha=.2, fill='green') + #low/no CyanoHAB
  annotate('rect', xmin=min(Me_cyano$daynum), xmax=max(Me_cyano$daynum),
           ymin=20000, ymax=100000, alpha=.2, fill='orange')+ #moderate CyanoHAB
  annotate('rect', xmin=min(Me_cyano$daynum), xmax=max(Me_cyano$daynum),
           ymin=100000, ymax=Inf, alpha=.2, fill='red') +#severe CyanoHAB
  labs(x="Date", y="Cyanobacteria Density (cells/mL)")
grid.arrange(a,b, nrow=2, ncol=1)
ggsave("Products/SI_figures/Figure4.png") #saves plot to Products folder
```

CRB and CD data plotted. 

# Step 4. Bin observations into same daynumber each year:

a) defining expected observation frequencies...
```{r}
Yr<- seq(from=2012, #define year start of study period
             to=2018, #define year end of study period
             by=1) #creates a sequence every 1 year
Yr #prints the expected years of data
daynum_bins<- seq(from=196, #define date start of CyanoHAB season
                  to=258, #define date end of CyanoHAB season
                  by=14) #creates a sequence every 14 days 
daynum_bins #prints the expected observation dates of data
cyanoHAB<- data.frame(Yr=rep(Yr, each=5), daynum_bin=rep(daynum_bins, times=7)) #create data frame with expected year and day number
```

Defined expected observation frequency.

b) binning Chl observed dates into expected dates...

```{r}
Me_Chl2 <- Me_Chl  %>%
  mutate(daynum_bin=
         ifelse(daynum<(daynum_bins[2]-7), #if observation is <= bin 2 min
                daynum_bins[1], #yes returns bin 1
                ifelse(daynum>=(daynum_bins[2]-7)&daynum<(daynum_bins[3]-7),
              #if observation is > bin 2 min and <= bin 3 min
              daynum_bins[2], #yes returns bin 2
              ifelse(daynum>=(daynum_bins[3]-7)&daynum<(daynum_bins[4]-7),
                     #if observation is > bin 3 min and <= bin 4 min
                     daynum_bins[3], #yes returns bin 3
                     ifelse(daynum>=(daynum_bins[4]-7)&daynum<(daynum_bins[5]-7),
                            #if observation is > bin 4 min and <= bin 5 min 
                            daynum_bins[4], #yes returns bin 4
                            daynum_bins[5])#no returns bin 5
                     )
              )
       ) 
)
Me_Chl2<- Me_Chl2 %>% 
  filter(!duplicated(cbind(Yr, daynum_bin), fromLast = TRUE)) %>% #remove first duplicate
  filter(Yr!=2017) #remove erroneous data
```

Observed dates assigned to closest expected dates.

b) binning CD observed dates into expected dates...

```{r}
Me_cyano2 <- Me_cyano  %>% 
  filter(Yr>=2012 & Yr<=2018) %>% #filter for study years
  filter(daynum >=189 & daynum <=265) %>% #filter for CyanoHAB season +- 7 days
  mutate(daynum_bin=
         ifelse(daynum<(daynum_bins[2]-7), #if observation is <= bin 2 min
                daynum_bins[1], #yes returns bin 1
                ifelse(daynum>=(daynum_bins[2]-7)&daynum<(daynum_bins[3]-7),
              #if observation is > bin 2 min and <= bin 3 min
              daynum_bins[2], #yes returns bin 2
              ifelse(daynum>=(daynum_bins[3]-7)&daynum<(daynum_bins[4]-7),
                     #if observation is > bin 3 min and <= bin 4 min
                     daynum_bins[3], #yes returns bin 3
                     ifelse(daynum>=(daynum_bins[4]-7)&daynum<(daynum_bins[5]-7),
                            #if observation is > bin 4 min and <= bin 5 min 
                            daynum_bins[4], #yes returns bin 4
                            daynum_bins[5])#no returns bin 5
                     )
              )
       ) 
)
Me_cyano2<- Me_cyano2 %>% 
  filter(!duplicated(cbind(Yr, daynum_bin), fromLast = TRUE)) #remove first duplicate
```

Observed dates assigned to closest expected dates.

c) merging the data frames with expected bins...
Note, R only merges two data frames at one time.

```{r}
cyanoHAB_Chl<- merge(cyanoHAB, #x data frame
                 Me_Chl2, #y data frame
                 by=c("Yr","daynum_bin"),
                 all.x=TRUE) #define the key fields
cyanoHAB_Chl<- cyanoHAB_Chl %>%
  filter(Yr!=2017) #remove missing year

cyanoHAB_CD<- merge(cyanoHAB, #x data frame
                 Me_cyano2, #y data frame
                 by=c("Yr","daynum_bin"),
                 all.x=TRUE) #define the key fields
```

Data merged.

# Step 5. Check for NAs:

```{r}
### checking for NAs ###
summary(cyanoHAB_Chl$Chla_ugL)
summary(cyanoHAB_CD$CD_cellsmL)

### fill missing values with the annual mean ###
cyanoHAB_Chl<- cyanoHAB_Chl %>%
  group_by(Yr) %>%
  mutate(across(Chla_ugL, ~na.aggregate(., FUN=mean, na.rm=TRUE))) %>%
  ungroup()

cyanoHAB_CD<- cyanoHAB_CD %>%
  group_by(Yr) %>%
  mutate(across(CD_cellsmL, ~na.aggregate(., FUN=mean, na.rm=TRUE))) %>%
  ungroup()
### check that missing values replaced with means ###
summary(cyanoHAB_Chl$Chla_ugL)
summary(cyanoHAB_CD$CD_cellsmL)
```

Missing values interpolated.

# Step 6. Save as new data file:

```{r}
write.csv(cyanoHAB_Chl, file="Cleaned_data/cyanoHAB_severity_Chla.csv")
write.csv(cyanoHAB_CD, file="Cleaned_data/cyanoHAB_severity_CD.csv")
```

# Additional, 3D graphs of response variables for entire year:

a) 3D plot of Chl-a across day number and year...

```{r}
Me_Chl<- Chl %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30"), #tells R to format field as Date
         Chla_ugL= tri_chl_spec, #renames field to common name with units
         ) %>% 
  filter(lakeid=="ME", #filter for Lake Mendota data
         depth_range_m=="0-8", #filter for data from integrated samples 0 to 8m
         rep=="1") %>% #remove QA analytic replicates
  filter(!is.na(Chla_ugL)) %>% #removes NAs in chl-a data
  select(sampledate, Chla_ugL) #selects only fields of interest

date_range<- seq( #creates a vector of sequence data
  min(Me_Chl$sampledate), #starting at the first sample date
  max(Me_Chl$sampledate), #ending at the last sample date
  by="1 day") #observations every day  
interpolated<- approx( #creates a vector of data that linearly interpolates 
  Me_Chl$sampledate, #across date
  Me_Chl$Chla_ugL, #the predicted values of Chl-a
  xout=date_range) #for every 1 day
Chla_interp <- data.frame( #creates a new data frame that has 
  sampledate = as.Date(interpolated$x), #renames the new vector as common field 
  Chla_ugL=interpolated$y) #renames the new vector as common field with units

Chla_interp<- Chla_interp %>%
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #adds field with year
         daynum=as.numeric(format(sampledate, "%j")) #adds field with day of yr
         ) %>%
  filter(Yr>=2012 & Yr<=2018) #filter for study period

SI_fig5a<- plot_ly(x=Chla_interp$Yr, 
  y=Chla_interp$daynum, 
  z=Chla_interp$Chla_ugL, 
  type="scatter3d", mode="markers",
  color=Chla_interp$Chla_ugL) %>%
  layout(scene=list(xaxis=list(title="Year"),
         yaxis=list(title="Day of Year"),
         zaxis=list(title="Chlorophyll-a (ug/L)")))
SI_fig5a #prints the plot
```

b) 3D plot of CD across day number and year...

```{r}
Me_cyanoRB<- phyto %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30")) %>% #tells R to format field as Datey
  filter(lakeid=="ME", #filter for Lake Mendota data
         depth_range=="0-8m", #filter for data from integrated samples 0 to 8m
         division=="Cyanophyta") %>% #filter for cyanobacteria data
  group_by(sampledate) %>% #group all observations by sample date
  summarize(relbiovol=sum(relative_total_biovolume), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(cells_per_ml)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(relbiovol<=100) %>% #remove any invalid records (>100%  not valid entry)   
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j"))) %>% #adds field with day
  filter(Yr>=2012 & Yr<=2018) #filter for study years

date_range<- seq( #creates a vector of sequence data
  min(Me_cyanoRB$sampledate), #starting at the first sample date
  max(Me_cyanoRB$sampledate), #ending at the last sample date
  by="1 day") #observations every day  
interpolated<- approx( #creates a vector of data that linearly interpolates 
  Me_cyanoRB$sampledate, #across date
  Me_cyanoRB$CD_cellsmL, #the predicted values of Cyanos
  xout=date_range) #for every 1 day
CD_interp <- data.frame( #creates a new data frame that has 
  sampledate = as.Date(interpolated$x), #renames the new vector as common field 
  CD_cellsmL=interpolated$y) #renames the new vector as common field with units

CD_interp<- CD_interp %>%
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #adds field with year
         daynum=as.numeric(format(sampledate, "%j")) #adds field with day of yr
         ) %>%
  filter(Yr>=2012 & Yr<=2018) #filter for study period

SI_fig5b<- plot_ly(x=CD_interp$Yr, 
  y=CD_interp$daynum, 
  z=CD_interp$CD_cellsmL, 
  type="scatter3d", mode="markers",
  color=CD_interp$CD_cellsmL)%>%
  layout(scene=list(xaxis=list(title="Year"),
         yaxis=list(title="Day of Year"),
         zaxis=list(title="Cyanobacteria Density (cells/mL)")))
SI_fig5b #prints the figure
```

c) save figures and data

```{r}
ggsave("Products/SI_figures/Figure5a_color.png") #saves plot to Products folder
write.csv(Chla_interp, file="Products/SI_figures/Figure5a_data.csv") #saves data
ggsave("Products/SI_figures/Figure5b_color.png") #saves plot to Products folder
write.csv(CD_interp, file="Products/SI_figures/Figure5b_data.csv") #saves data
```

