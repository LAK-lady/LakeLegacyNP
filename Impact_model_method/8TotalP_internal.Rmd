---
title: "TotalP_internal.Rmd"
author: "Lauren A. Knose, ORISE-EPA"
date: '2024-06-01'
output: html_document
editor_options: 
  chunk_output_type: console
---

The purpose of this program is to calculate the internal legacy P loading for Lake Mendota, WI.

# Step 1. Load dependent packages and data needed:

a) loading dependent packages...

```{r}
library(ggplot2) #needed for plots
library(dplyr) #needed for reformating data
library(zoo) #needed to linearly interpolate missing values
library(reshape2) #needed to reshape data from wide to long
```

Packages loaded.

b) loading dependent data...

```{r}
P_vol<- read.csv(file="Cleaned_data/TotalP_water.csv") 
P_ratio<- read.csv(file="Cleaned_data/TotalP_ratio.csv")
```

# Step 2. Calculate internal P loads:

a) sub-setting data...

```{r}
### separate records with change in epi volume into separate data frame ###
Int_P<- P_vol %>%
  filter(!is.na(Vol_epi_m3)) # filter for records with change in volume values
```

Data subset.

b) interpolating missing P observations...

```{r}
### identify NAs ###
summary(Int_P$TotP_mgL)
summary(P_ratio$TotP_HEratio)

### interpolate missing total P concentrations ###
Int_P$TotP_mgL<- na.approx(Int_P$TotP_mgL) #interpolates NAs
```

Missing total P interpolated.

c) calculating internal P load from volume change and P concentration:

```{r}
### define units and conversion coefficients ###
t<- 14 #length between observations in days
mgL_mgm3<- 1000/1 #conversion factor from mg/L to mg/m^3
mg_kg<- 1/1000000 #conversion factor from mg to kg
A_unstrat<- 13980000 #unstratified lake surface area, where sediments are 
# directly adjacent to epilimnion in m^2
Sed_P<- 2.4 # mg P/m2-day (average based on previous study by Stauffer 1987 who 
# determined the average sediment release of P from sediments in contact with 
#the epilimnion in Lake Mendota (original range was 1.2 to 3.5 mg P /m2-day), measured by sediment cores.

### calculate P loads ###
Int_P<- Int_P %>%
  mutate(Strat_TotP_kgday= (TotP_mgL*mgL_mgm3*mg_kg)*Vol_epi_m3/t, #calculates 
        #internal P load from stratified area
        Unstr_TotP_kgday=(Sed_P*A_unstrat*mg_kg), #calculates internal P loading
        #from unstratified area
        Int_TotP_kgday= Unstr_TotP_kgday+Strat_TotP_kgday) #calculates total internal
#legacy P loading)
```

Internal P loads calculated.

# Step 3. Interpolate daily observations:

a) define expected daily frequencies...

```{r}
### determine expected observation frequencies ###
Yr<- seq(from=2013, #define year start of study period
             to=2018, #define year end of study period
             by=1) #creates a sequence every 1 year
Yr #prints the expected years of data
daynum_bins<- seq(from=196, #define date start of CyanoHAB season
                  to=252, #define date end of CyanoHAB season
                  by=1) #creates a sequence every 1 day 
daynum_bins #prints the expected observation dates of data

### create data frame with the frequencies wanted ###
x<- rep(Yr, each=57)
y<- rep(daynum_bins, times=6)
df<- data.frame(x,y)
df<- df %>%
  rename(Yr=x, daynum_bin=y)
```

Expected daily frequencies defined.

b) merging data to expected frequencies... 

```{r}
### merge observations with data frame of frequencies ###
Int_P2<- merge(Int_P, df, by=c("Yr","daynum_bin"), all.y=TRUE) 
P_ratio2<- merge(P_ratio, df, by=c("Yr", "daynum_bin"), all.y=TRUE)
```

Data merge.

c) interpolating missing daily values...

```{r}
### interpolate the missing P_int based ###
Int_P2$Strat_TotP_kgday<- na.approx(Int_P2$Strat_TotP_kgday) #interpolates where NA
Int_P2$Unstr_TotP_kgday<- na.approx(Int_P2$Unstr_TotP_kgday) #interpolates where NA
Int_P2$Int_TotP_kgday<- na.approx(Int_P2$Int_TotP_kgday) #interpolates where NA

### interpolate the missing P_ratio ###
P_ratio2$TotP_HEratio<- na.approx(P_ratio2$TotP_HEratio) #interpolates where NA
P_ratio2$epi_TotP_mgL<- na.approx(P_ratio2$epi_TotP_mgL) #interpolates where NA
P_ratio2$hypo_TotP_mgL<- na.approx(P_ratio2$hypo_TotP_mgL) #interpolates where NA
```

Daily observations interpolated.

# Step 4. Merge and save the data as a new data file:

```{r}
### merge data frames ###
allint<- merge(Int_P2, P_ratio2, by=c("Yr","daynum_bin"))

### save as new data file ###
write.csv(allint, file="Cleaned_data/TotalP_allint.csv")
```

# Step 4. Summarize and view the data:

a) calculating average daily values during the CyanoHAB season...

```{r}
### calculating average daily internal P load ###
IntP_dayavg<- allint %>%
  summarize(mean=mean(Int_TotP_kgday, na.rm=TRUE), #calculate mean
            se=(sd(Int_TotP_kgday, na.rm=TRUE)/sqrt(length(Int_TotP_kgday))),
            min=min(Int_TotP_kgday, na.rm=TRUE),
            max=max(Int_TotP_kgday, na.rm=TRUE)
            )
IntP_dayavg

### calculating average daily P_hypo:epi ###
Pratio_dayavg<- allint %>%
  summarize(mean=mean(TotP_HEratio, na.rm=TRUE), #calculate mean
            se=(sd(TotP_HEratio, na.rm=TRUE)/sqrt(length(TotP_HEratio))),
            min=min(TotP_HEratio, na.rm=TRUE),
            max=max(TotP_HEratio, na.rm=TRUE)
            )
Pratio_dayavg
```

Average daily int P load calculated.

b) calculating average annual values during the CyanoHAB season...

```{r}
### calculating average annual internal P load ###
IntP_yr<- allint %>%
  group_by(Yr) %>%
  summarize(sum=sum(Int_TotP_kgday)) #add total P load
IntP_yr
IntP_yravg<- IntP_yr %>%
  summarize(mean=mean(sum, na.rm=TRUE), #print the average annual
            se=sd(sum, na.rm=TRUE)/sqrt(length(sum)),
            min=min(sum, na.rm=TRUE),
            max=max(sum, na.rm=TRUE)) #print sd for avg
IntP_yravg #the estimated annual average P_ext with the P_other

### calculating average P_hypo:epi for each year ###
Pratio_dayavg<- allint %>%
  group_by(Yr) %>%
  summarize(mean=mean(TotP_HEratio, na.rm=TRUE), #calculate mean
            se=(sd(TotP_HEratio, na.rm=TRUE)/sqrt(length(TotP_HEratio))),
            min=min(TotP_HEratio, na.rm=TRUE),
            max=max(TotP_HEratio, na.rm=TRUE)
            )
Pratio_dayavg
```

Average annual int P load calculated.

c) calculating the average daily values by source (unst vs strat)...

```{r}
IntP_dayavg_source<- allint %>%
  summarize(mean_unstr=mean(Unstr_TotP_kgday, na.rm=TRUE), #calculate mean
            se_unstr=(sd(Unstr_TotP_kgday, na.rm=TRUE)/sqrt(length(Unstr_TotP_kgday))),
            min_unstr=min(Unstr_TotP_kgday, na.rm=TRUE),
            max_unstr=max(Unstr_TotP_kgday, na.rm=TRUE),
            mean_strat=mean(Strat_TotP_kgday, na.rm=TRUE), #calculate mean
            se_strat=(sd(Strat_TotP_kgday, na.rm=TRUE)/sqrt(length(Strat_TotP_kgday))),
            min_strat=min(Strat_TotP_kgday, na.rm=TRUE),
            max_strat=max(Strat_TotP_kgday, na.rm=TRUE)
            )
IntP_dayavg_source
```

Average daily P_int summarized.
