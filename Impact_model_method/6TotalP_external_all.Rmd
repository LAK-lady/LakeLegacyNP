---
title: "TotalP_external_all.Rmd"
author: "Lauren A. Knose, ORISE-EPA"
date: '20234-05-31'
output: html_document
editor_options: 
  chunk_output_type: console
---

The purpose of this program is to calculate total external P load from both atmospheric deposition and stream inflows.

# Step 1. Load dependent packages and data needed:

a) Loading dependent packages...

```{r}
library(ggplot2) #needed for plots
library(dplyr) #needed for reformaing data
library(reshape2) #needed for reshaping data frames from wide to long
```

Packages loaded.

b) Loading dependent data....

```{r}
streams<- read.csv(file="Cleaned_data/TotalP_inflows.csv") 
atm<- read.csv(file="Cleaned_data/TotalP_atm.csv")
```

Data loaded.

# Step 2. Reformat and merge data:

a) reformatting data...

```{r}
### identify keys to filter ###
colnames(streams) #print column names
unique(streams$Site) #print the different site names

### filter stream data ###
streams2<- streams %>%
  mutate(X=NULL, #remove index column
         sampledate=as.Date(sampledate,
                            origin="1899-12-30",
                            format="%Y-%m-%d")) %>%
  filter(Site=="All") %>%
  mutate(Pstreams_kgday=Flux) %>%#reformat date
  filter(daynum>=196 & daynum<=252) %>% #filter for the CyanoHAB season
  filter(Yr>=2013 & Yr<=2018) %>% #filter for the study period
  select(sampledate, Yr, daynum, Pstreams_kgday) #remove unecessary fields

### identify keys to filter ###
colnames(atm) #print column names

### filter atmospheric deposition data ###
atm2<- atm %>%
  mutate(X=NULL, #remove index column
         sampledate=as.Date(sampledate, origin="1899-12-30"),
         Patm_kgday=atm_TotP_kgday)%>% #reformat date
  filter(daynum>=196 & daynum<=252) %>% #filter for the CyanoHAB season
  filter(Yr>=2013 & Yr<=2018) #filter for the study period
```

Data reformatted.

b) merging data...

```{r}
### merge the two data files ###
extP_load<- merge(atm2, streams2, by=c("Yr", "daynum")) #adds two data files together
```

Data merged.

# Step 3. Calculate Pother and total P loads:

```{r}
### add fields for total P with and without other P sources ###
extP_load <- extP_load %>%
  mutate(Pext_kgday_noother=(Patm_kgday + Pstreams_kgday), #combine atm P and stream P
         Pother_kgday=(Pext_kgday_noother*.47), #assign new column for P_other with 47% of total
         Pext_kgday=Pext_kgday_noother*1.47) %>% #increase P_ext 47% to account for P_other
  rename(sampledate=sampledate.x) %>%
  select(!c(sampledate.y))
```

External P loading merged.

# Step 3. Save data as new data file:

```{r}
write.csv(extP_load, file="Cleaned_data/TotalP_allext.csv")
```

New data file created with total external P loading.

# Step 4. Summarize and view data:

a) calculating average daily and average annual external P loads...

```{r}
### average daily external P load ###
Pext_day<- extP_load %>%
  summarize(mean=mean(Pext_kgday, na.rm=TRUE), #calculate mean
            se=(sd(Pext_kgday, na.rm=TRUE)/sqrt(length(Pext_kgday))),
            min=min(Pext_kgday, na.rm=TRUE),
            max=max(Pext_kgday, na.rm=TRUE)
            )
Pext_day # the estimated daily average  P_ext with P_other

### calculate average Pext per m2 ###
A_lake_km2 = 39.40 #surface area of lake in km^2
Pext_day/A_lake_km2 

### sum annual external P load ###
Pext_yr<- extP_load %>%
  mutate(Yr=format(sampledate, "%Y")) %>% #add field with year
  group_by(Yr) %>%
  summarize(sum=sum(Pext_kgday, na.rm = TRUE)) #calculate total P_ext per year
Pext_yr

### average annual external P load ###
Pext_yr_avg<- Pext_yr %>%
  summarize(mean=mean(sum, na.rm=TRUE), #print the average annual
            se=sd(sum, na.rm=TRUE)/sqrt(length(sum)),
            min=min(sum, na.rm=TRUE),
            max=max(sum, na.rm=TRUE)) #print sd for avg
Pext_yr_avg #the estimated annual average P_ext with the P_other
```

P_ext summarized.

b) calculating P_streams for whole year (not just cyanoHAB season)...

```{r}
streams_yr<- streams %>%
  filter(Yr>=2013 & Yr <=2018) %>%
  group_by(Yr) %>%
  summarize(sum=sum(Flux, na.rm=TRUE))
streams_yr
streams_yr_avg<- streams_yr %>%
  summarize(mean=mean(sum, na.rm=TRUE), #print the average annual
            se=sd(sum, na.rm=TRUE)/sqrt(length(sum)),
            min=min(sum, na.rm=TRUE),
            max=max(sum, na.rm=TRUE)) #print sd for avg
streams_yr_avg #the estimated annual average P_ext with the P_other
```

Annual stream P loads estimated.

c) plotting annual loads by source...

```{r}
### reshape data frame to long format ###
extP_load_long<- melt(extP_load, #the table you want to reshape wide to long
               id.vars=c("sampledate")) #the column to use as unique id

### rename fields ###
extP_load_long<- extP_load_long %>%
  rename(Source=variable,
         Pext_kgday=value)
extP_load_long$Source<-as.character(extP_load_long$Source) #tell R character data
extP_load_long<- extP_load_long %>%
  mutate(Yr=as.character(format(sampledate, "%Y"))) # adds field with year

### select the three external sources ###
unique(extP_load_long$Source)
extP_load_source<- extP_load_long %>% #filter for the three factors
  filter(Source=="Patm_kgday"| Source=="Pstreams_kgday"|Source=="Pother_kgday") 
extP_load_source$Source[extP_load_source$Source=="Patm_kgday"] <- "atmosphere"
extP_load_source$Source[extP_load_source$Source=="Pstreams_kgday"] <- "streams"
extP_load_source$Source[extP_load_source$Source=="Pother_kgday"] <- "other"

### summarize each source by year ###
extP_load_source_sum<- extP_load_source %>%
  group_by(Yr, Source) %>%
  summarize(totP_kgyr=sum(Pext_kgday, na.rm=TRUE))
extP_load_source_sum #print table

### plot total extP by source and year ###  
SI_fig12<- ggplot(extP_load_source_sum, aes(x=Yr, y=totP_kgyr, 
                             fill=Source)) + #separate sources by fill color
  geom_bar(position="stack", stat="identity", color="black") + #stacked bar graph
  scale_fill_manual(values=c("grey", "white", "black")) + #atm = grey, streams=black, other=white
  theme_classic(base_size=12) +
  labs(x="Year", y="External total P loading (kg/yr)")
SI_fig12 #print plot
ggsave(SI_fig12, file="Products/SI_figures/Figure12.png")
```

Total P load by source for each year plotted.

d) summarizing daily and annual P_ext by source...

```{r}
### average daily external P load by source ###
Pext_day_source<- extP_load_source %>%
  group_by(Source) %>%
  summarize(mean=mean(Pext_kgday, #average daily total P loading
                      na.rm=TRUE),
            se=(sd(Pext_kgday, na.rm=TRUE)/sqrt(length(Pext_kgday))),
            min=min(Pext_kgday, na.rm=TRUE),
            max=max(Pext_kgday, na.rm=TRUE))
Pext_day_source

### sum annual external P load by source ###
extP_load_long_yr<- extP_load_source %>%
  group_by(Yr, Source) %>%
  summarize(sum=sum(Pext_kgday)) #add total P load
extP_load_long_yr #print table

### average annual external P load by source ###
extP_load_long_yr_avg<- extP_load_long_yr %>%
  group_by(Source) %>%
  summarize(mean=mean(sum, na.rm=TRUE), #print the average annual
            se=sd(sum, na.rm=TRUE)/sqrt(length(sum)),
            min=min(sum, na.rm=TRUE),
            max=max(sum, na.rm=TRUE)) #print sd for avg
extP_load_long_yr_avg  
```

P_ext summarized by source.
