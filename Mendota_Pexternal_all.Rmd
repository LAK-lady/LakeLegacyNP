---
title: "Mendota_TotP_ext_all.Rmd"
author: "Lauren A. Knose, ORISE-EPA"
date: '2023-06-20'
output: html_document
editor_options: 
  chunk_output_type: console
---

The purpose of this program is to calculate total external P load from both 
atmospheric deposition and stream inflows.

# Step 1. Load dependent packages and data needed:

a) Loading dependent packages...

```{r}
library(ggplot2) #needed for plots
library(dplyr) #needed for reformaing data
library(reshape2) #needed for reshaping data frames from wide to long
```

Packages loaded.

b) Loading dependent data....

```{r}
streams<- read.csv(file="Cleaned_data/Mendota_P_inflows.csv") 
atm<- read.csv(file="Cleaned_data/Mendota_P_atm.csv")
```

Data loaded.

# Step 2. Transform and merge data:

a) transforming data...

```{r}
streams2<- streams %>%
  mutate(X=NULL, #remove index column
         sampledate=as.Date(sampledate, origin="1899-12-30"))#reformat date
atm2<- atm %>%
  mutate(X=NULL, #remove index column
         sampledate=as.Date(sampledate, origin="1899-12-30")) #reformat date
```

Data transformed.

b) merging data...

```{r}
extP_load<- merge(atm2, streams2, by="sampledate") #adds two data files together
extP_load <- extP_load %>%
  mutate(total=(atm_TotP_kgday + allInflows_TotP_kgday), #combine atm P and stream P
         daynum=as.integer(format(sampledate, "%j")),
         Yr=as.integer(format(sampledate, "%Y")),
         daynum.x=NULL, Yr.x=NULL, daynum.y=NULL, Yr.y=NULL #remove duplicate columns
         ) #remove duplicate column
```

External P loading merged.

# Step 3. Summarize and view data:

a) plot total P load for CyanoHAB season by source for each year...
```{r}
extP_load_long<- melt(extP_load, #the table you want to reshape wide to long
               id.vars=c("sampledate"), #the column to use as unique id
               measure.vars=c("atm_TotP_kgday","allInflows_TotP_kgday"), 
               #the columns where values will be taken
               variable.name="Source", #label the source of P loading
               value.name="TotP_kgday" #label the value with units
               )
extP_load_long$Source<-as.character(extP_load_long$Source) #tell R character data held
extP_load_long$Source[extP_load_long$Source=="atm_TotP_kgday"] <- "atmosphere"
extP_load_long$Source[extP_load_long$Source=="allInflows_TotP_kgday"] <- "streams"

extP_load_long<- extP_load_long %>%
  mutate(Yr=format(sampledate, "%Y") #add year back in data frame
         ) %>%
  group_by(Yr, Source) %>% #for each year and each source
  summarize(TotP_kgday=sum(TotP_kgday)) #sum up all the TotP_kgday

ggplot(subset(extP_load_long, Yr<=2018), aes(x=Yr, y=TotP_kgday, 
                             fill=Source)) + #separate sources by fill color
  geom_bar(position="stack", stat="identity", color="black") + #stacked bar graph
  scale_fill_manual(values=c("grey", "black")) + #atm = grey, streams=black
  theme_classic(base_size=12) +
  labs(x="Year", y="Total P loading (kg/yr)") 
```

Total P load by source for each year plotted.

b) calculate average daily total P load for CyanoHAB season...

```{r}
extP_load_dayavg<- extP_load %>%
  filter(daynum>=195 & daynum<=255) %>% #filter for the CyanoHAB season 
  summarize(mean=mean(total, na.rm=TRUE), #calculate mean
            se=(sd(total, na.rm=TRUE)/sqrt(length(total))),
            min=min(total, na.rm=TRUE),
            max=max(total, na.rm=TRUE)
            )
extP_load_dayavg
```

b) calculating average annual total P load for CyanoHAB season...

```{r}
extP_load_yravg<- extP_load %>%
  filter(Source=="total") %>% #for the total external P load
  group_by(Yr) %>%
  summarize(sum=sum(TotP_kgday))
extP_load_yravg
```

The average annual total P load was `r mean(extP_load_yravg$sum)` +- 
`r (sd(extP_load_yravg$sum)/sqrt(length(extP_load_yravg$sum)))` kg/yr. 

# Step 4. Save data as new data file:

```{r}
totextP_load<- extP_load %>%
  filter(Source=="total") %>% #filter for total external P load
  mutate(Source=NULL, #remove extra column
         extTotP_kgday=TotP_kgday, #rename value column
         TotP_kgday=NULL) #remove duplicate column
write.csv(totextP_load, file="Cleaned_data/Mendota_P_allext.csv")
```

New data file created with total external P loading.