---
title: "Mendota_EpiVolume"
author: "Lauren A. Knose, ORISE-EPA"
date: '2023-02-14'
output: html_document
editor_options: 
  chunk_output_type: console
---

The purpose of this program is to identify the thermocline depth from daily temperature profiles and calculate the daily volumes of each lake layer   (epilimnion, metalimnion, hypolimnion).

# Step 1. Load dependent packages and data:

a) loading dependent packages...

```{r}
library(ggplot2) #needed for plots
library(dplyr) #needed for reformatting data
library(tidyverse) #needed for organizing data
library(lubridate) #needed for date processing
library(rLakeAnalyzer) #needed to find thermocline depth from temperature profile
library(reshape2) #needed to reshape data frame
```

Packages loaded.

b) loading dependent data...

```{r}
watertemp<-read.csv(file="Original_data/ntl29_v12.csv") #data from temp string
```

Data loaded.

# Step 2. Filter and transform the data:

```{r}
watertemp2<- watertemp %>%
  filter(lakeid=="ME") %>% #filter for Lake Mendota data only
  filter(rep==1) %>% #filter for rep 1 (no analytical reps)
  filter(!is.na(wtemp)) %>% #remove NAs
  select(sampledate, depth, wtemp) %>% #select columns of interest
  mutate(sampledate=as.Date(sampledate, format="%m/%d/%Y",
                            origin="1899-12-30"), #reformat date
         depth_m=depth, #add units to column
         depth=NULL, #remove duplicate column
         watertemp_C=wtemp,#rename column with units
         wtemp=NULL,  #remove duplicate column
         daynum=as.integer(format(sampledate, format="%j")),
         Yr=as.integer(format(sampledate, "%Y"))) %>% 
  filter(Yr>=2012 & Yr <=2018) %>% #filter for the study years 
  filter(daynum>= 195 & daynum <=255) #filter for the CyanoHAB season
```

Temp data filtered and transformed.

# Step 3. View data:

Note, using R code from Dr. Dewey Dunnington (Canada).
```{r}
ggplot(data=watertemp2, #create limno plot with depth inverse on y-axis
       aes(x=sampledate, #sampled date as x-axis
           y=depth_m, 
           color=watertemp_C)) + #and data points colored by temperature
  geom_point() + 
  scale_y_reverse() + #inverses the y-axis from zero to max(depth)
  scale_color_gradient(high=scales::muted("red"), #red = hot temp
                        low=scales::muted("blue"), #blue = cold temp
                        name="Water Temperature (C)") + 
  geom_hline(yintercept=8, lty="dashed") +
  theme_classic() +
  labs(x="Date", y="Depth (m)", 
  caption="Horizontal dashed line indicates epilimnion maximum used for sampling at 8 m.") 
```

# Step 4. Calculate the thermocline depth for each day using rLakeAnalyzer:

a) reshaping the data frame for package...
```{r}
wtr<- watertemp2 %>%
  select(sampledate, depth_m, watertemp_C) #only include needed columns
wtr<- dcast(wtr, sampledate ~ depth_m) # cast data frame from long to wide
colnames(wtr)<- paste("wtr", colnames(wtr), sep="_") #add wtr_ before depth
wtr<- wtr %>%
  mutate(datetime=wtr_sampledate, wtr_sampledate=NULL) #rename using package 
  #column headers
```

Data frame reshaped and ready for input into the package.

b) using ts.thermo.depth function to calculate thermocline depth...

```{r}
t.d<- ts.thermo.depth(wtr, na.rm=TRUE) #calculates thermocline depth as time series
```

Thermocline depth calculated.

c) plotting the thermocline depth by day during CyanoHAB season...

```{r}
ggplot(data=t.d, aes(x=as.integer(format(datetime, "%j")), y=thermo.depth,
                     shape=as.factor(format(datetime, "%Y")))) + #plots the time series
  geom_point() + #adds points
  geom_line() + #adds lines
  scale_shape_manual(values=c(0,1,2,3,4,5,6,7))+ #need to specify shapes if n>6
  scale_y_reverse() + #plots y axis in reverse
  theme_classic() +
  theme(text=element_text(size=12)) +
  labs(x="Sample Date", y="Thermocline depth (m)",
       shape="Year")
```

Thermocline depth calculated for each sample date and plotted. 

# Step 5. Interpolate missing data:

```{r}
td_date_range<- seq( #creates a vector of sequence data
  min(t.d$datetime), #starting at the first sample date
  max(t.d$datetime), #ending at the last sample date
  by="1 day") #observations every 14 days (bimonthly) 
td_interpolated<- approx( #creates a vector of data that linearly interpolates
  t.d$datetime, #across date
  t.d$thermo.depth, #the predicted values of Hypo P: Epi P
  xout=td_date_range) #for every 1 day
td_interp <- data.frame( #creates a new data frame that has 
  sampledate = as.Date(td_interpolated$x), #measurements every 14 days
                             Thermo_depth_m=td_interpolated$y) #predicted hypo: epi P
td_interp<- td_interp %>%
  mutate(daynum=as.integer(format(sampledate, "%j")), #add back in day number
         Yr=as.integer(format(sampledate, "%Y"))) %>% #add back in year
  filter(daynum >= 195 & daynum <= 255) %>% #filter for CyanoHAB season
  filter(Yr >=2012 & Yr <= 2018) #filter for study period
```

Daily thermocline depth calculated.

# Step 6. Calculate the change in volume of epilimnion due to thermocline depth:

```{r}
A_strat= 25850000 # basin surface area of stratified region in m^2 
therm_chg<- td_interp %>%
  mutate(Thermo_depth_m_k1=lag(Thermo_depth_m, n=1), #thermocline depth at t-1 
         Chg_depth_m = (Thermo_depth_m - Thermo_depth_m_k1),#calculate daily change in depth 
         Vol_epi_m3 = Chg_depth_m*A_strat) #calculate daily change in volume
```

Daily change in epilimnion volume calculated.


# Step 7. Save data as new data file. 

```{r}
write.csv(therm_chg, file="Cleaned_data/Mendota_EpiVolume.csv")
```

Data saved as new file in Cleaned_data folder as Mendota_EpiVolume.csv"
