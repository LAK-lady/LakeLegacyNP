---
title: "cyanoHAB_season"
author: "Lauren Knose"
date: "2024-05-7"
output: html_document
editor_options: 
  chunk_output_type: console
---

The purpose of this program is to define the cyanoHAB season using the data available.

# Step 1. Load dependent packages and data:

a) loading the dependent packages...

```{r}
library(ggplot2) #needed for plots
library(dplyr) #needed for reshaping/reformating data
library(reshape2) #needed for reformatting data frames
library(ggpubr) #needed for formatting plots
```

Packages loaded.

b) loading the phytoplankton data...

```{r}
phyto<-read.csv(file="Cleaned_data/HarshaLake_phytoplankton.csv", header=TRUE) #has the phytoplankton community dataset
```

Phytoplankton community data loaded. 

c) loading the Secchi depth data...

```{r}
Secchi<- read.csv(file="Cleaned_data/HarshaLake_Secchi.csv") #has Secchi depth data
```

Secchi depth data loaded.

# Step 2. Define and reformat data:

a) defining and reformatting data for cyanobacteria relative biovolume (CRB) and cyanobacteria density (CD)...

```{r}
### identify the labels used for fields ###
colnames(phyto) #identify labels for fields to filter
unique(phyto$SiteID) #determine the label for the site
unique(phyto$Division) #determine the label for cyanobacteria
head(phyto$CollectionDate) #determine format for sample date
min(phyto$CollectionDate) #earliest sample date
max(phyto$CollectionDate) #latest sample date
unique(phyto$Depth_ft) #determine the depth most data was collected
summary(phyto$SampleSpecificCellRelativeAbundance_Perc) #check for NAs
summary(phyto$TaxaSpecificCellDensity_cellsmL) #check for NAs

### Site 1: BUO ###
BUO_cyanos<- phyto %>%
  mutate(sampledate=as.Date(CollectionDate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30")) %>% #tells R field contains dates
  filter(SiteID=="BUO", #filter for buoy site data
         Division=="Cyanobacteria"|Division==" Cyanobacteria ") %>% #filter for cyanobacteria data
  group_by(sampledate) %>% #group all observations by sample date
  summarize(cyano_relabund=sum(SampleSpecificCellRelativeAbundance_Perc, na.rm=TRUE), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(TaxaSpecificCellDensity_cellsmL, na.rm=TRUE)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(cyano_relabund<=100) %>% #remove any invalid records (>100%  not valid entry)
  ungroup()

### Site 2: EFL ###
EFL_cyanos<- phyto %>%
  mutate(sampledate=as.Date(CollectionDate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30")) %>% #tells R field contains dates
  filter(SiteID=="EFL", #filter for buoy site data
         Division=="Cyanobacteria"|Division==" Cyanobacteria ") %>% #filter for cyanobacteria data
  group_by(sampledate) %>% #group all observations by sample date
  summarize(cyano_relabund=sum(SampleSpecificCellRelativeAbundance_Perc), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(TaxaSpecificCellDensity_cellsmL)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(cyano_relabund<=100) %>% #remove any invalid records (>100%  not valid entry)
  ungroup()

### Site 3: EMB ###
EMB_cyanos<- phyto %>%
  mutate(sampledate=as.Date(CollectionDate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30")) %>% #tells R field contains dates
  filter(SiteID=="EMB", #filter for buoy site data
         Division=="Cyanobacteria"|Division==" Cyanobacteria ") %>% #filter for cyanobacteria data
  group_by(sampledate) %>% #group all observations by sample date
  summarize(cyano_relabund=sum(SampleSpecificCellRelativeAbundance_Perc), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(TaxaSpecificCellDensity_cellsmL)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(cyano_relabund<=100) %>% #remove any invalid records (>100%  not valid entry)
  ungroup()

### Site 4: ENN ###
ENN_cyanos<- phyto %>%
  mutate(sampledate=as.Date(CollectionDate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30")) %>% #tells R field contains dates
  filter(SiteID=="ENN", #filter for buoy site data
         Division=="Cyanobacteria"|Division==" Cyanobacteria ") %>% #filter for cyanobacteria data
  group_by(sampledate) %>% #group all observations by sample date
  summarize(cyano_relabund=sum(SampleSpecificCellRelativeAbundance_Perc), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(TaxaSpecificCellDensity_cellsmL)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(cyano_relabund<=100) %>% #remove any invalid records (>100%  not valid entry)
  ungroup()
```

Cyanobacteria data defined and filtered.

b) defining and reformatting the Secchi depth data...

```{r}
### identify the labels used for fields ###
colnames(Secchi) #identify labels for fields to filter
unique(Secchi$SiteID) #determine the label for the site
head(Secchi$SampleDate) #determine format for sample date
unique(Secchi$Variable) #check the variables 
unique(Secchi$Unit) #check units
in_m <- 0.0254 #conversion factor from inch to meter

### Site 1: BUO ###
BUO_Secchi<- Secchi %>%
  mutate(sampledate=as.Date(SampleDate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30"),#tells R to format field as Date
         SD_m=Value*in_m) %>% #adds units to field
  filter(SiteID=="BUO") %>% #filter for the two sample sites
  select(sampledate, SD_m) %>%  #select the fields needed
  group_by(sampledate) %>% #group data by sample date
  summarize(SD_m=mean(SD_m, na.rm = TRUE)) #average the Secchi depth 

### Site 2: EFL ###
EFL_Secchi<- Secchi %>%
  mutate(sampledate=as.Date(SampleDate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30"),#tells R to format field as Date
         SD_m=Value*in_m) %>% #adds units to field
  filter(SiteID=="EFL") %>% #filter for the two sample sites
  select(sampledate, SD_m) %>%  #select the fields needed
  group_by(sampledate) %>% #group data by sample date
  summarize(SD_m=mean(SD_m, na.rm = TRUE)) #average the Secchi depth 

### Site 3: EMB ###
EMB_Secchi<- Secchi %>%
  mutate(sampledate=as.Date(SampleDate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30"),#tells R to format field as Date
         SD_m=Value*in_m) %>% #adds units to field
  filter(SiteID=="EMB") %>% #filter for the two sample sites
  select(sampledate, SD_m) %>%  #select the fields needed
  group_by(sampledate) %>% #group data by sample date
  summarize(SD_m=mean(SD_m, na.rm = TRUE)) #average the Secchi depth 

### Site 4: ENN ###
ENN_Secchi<- Secchi %>%
  mutate(sampledate=as.Date(SampleDate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30"),#tells R to format field as Date
         SD_m=Value*in_m) %>% #adds units to field
  filter(SiteID=="ENN") %>% #filter for the two sample sites
  select(sampledate, SD_m) %>%  #select the fields needed
  group_by(sampledate) %>% #group data by sample date
  summarize(SD_m=mean(SD_m, na.rm = TRUE)) #average the Secchi depth 
```

Secchi depth data defined and filtered.

c) merging the data...
```{r}
cyanos<- phyto %>%
  mutate(sampledate=as.Date(CollectionDate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30")) %>% #tells R field contains dates
  filter(Division=="Cyanobacteria"|Division==" Cyanobacteria ") %>% #filter for cyanobacteria data
  group_by(SiteID, sampledate) %>% #group all observations by sample date
  summarize(cyano_relabund=sum(SampleSpecificCellRelativeAbundance_Perc), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(TaxaSpecificCellDensity_cellsmL)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(cyano_relabund<=100) %>% #remove any invalid records (>100%  not valid entry)
  ungroup()

Secchi2<- Secchi %>%
  mutate(sampledate=as.Date(SampleDate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30"),#tells R to format field as Date
         SD_m=Value*in_m) %>% #adds units to field
  select(SiteID, sampledate, SD_m) %>%  #select the fields needed
  group_by(SiteID, sampledate) %>% #group data by sample date
  summarize(SD_m=mean(SD_m, na.rm = TRUE)) %>% #average the Secchi depth 
  ungroup()

cyanoHAB_season<- merge(cyanos, Secchi2, by=c("SiteID", "sampledate"),
                       all =TRUE) #merges data frames and keeps all records 
cyanoHAB_season<- cyanoHAB_season %>%
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j"))) #adds field with day
```

Data merged.

# Step 3. View the data available:

a)  plotting Secchi depth and cyanobacteria relative biovolume to get cyanoHAB season...

```{r}
### plot the Secchi depth over time ###
a<- ggplot(data=cyanoHAB_season, aes(x=daynum, y=SD_m)) + #plots SD across day
  geom_point() + #plots observations as points
  theme_classic(base_size=12) +
  geom_smooth()+
  facet_wrap(~SiteID) +
  geom_vline(xintercept = 166, lty="dashed")+ #add line for June 15th
  labs(x="Day of year", y="Secchi depth (m)") +
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=152, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=258, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
a #print the figure

### plot the cyanobacteria relative abundance over time ####
b <- ggplot(data=cyanoHAB_season, aes(x=daynum, y=cyano_relabund)) + #plots cyano RB across day
  geom_point() + #plots observations as points
  theme_classic(base_size=12) +
  geom_smooth() + #adds regression curve
  
  labs(x="Day of year", 
       y="Cyanobacteria relative abundance") +
  geom_hline(yintercept = 90, lty="dashed") +
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=152, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=258, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
b #print the figure

### overlay both figures ###
cyanoHABseason<- ggarrange(a, b, nrow=2) #plot a over plot b
cyanoHABseason #print out plot

### save plot ###
ggsave("Products/HarshaLake_cyanoHABseason.png") #saves plot to Products folder
```

Data plotted.

# Step 4. Save the data

```{r}
write.csv(HL_cyanos, file="Cleaned_data/HarshaLake_cyanos.csv")
```