---
title: "cyanoHAB_severity.Rmd"
author: "Lauren A. Knose, ORISE-EPA"
date: '2023-02-15'
output: html_document
editor_options: 
  chunk_output_type: console
---

The following text and code documents how algal data was processed and analyzed.
Data was also converted to time series.

# Step 1. Load dependent packages and data:

a) loading the dependent packages...

```{r}
library(ggplot2) #needed for plots
library(ggbreak) #needed for plot scale breaks
library(dplyr) #needed for reshaping/reformaing data
```

Packages loaded.

b) loading the chlorophyll-a data...

```{r}
Chl<- read.csv(file="Original_data/ntl38_v5_chl.csv", header=TRUE) #has chl data
```

Chlorophyll-a data loaded. 

c) loading the phytoplankton data...

```{r}
phyto<-read.csv(file="Original_data/ntl88_v13_phytoplankton.csv", header=TRUE) #has the phytoplankton community dataset
```

Phytoplankton community data loaded. 

d) loading the Secchi depth data...

```{r}
Secchi<- read.csv(file="Original_data/ntl31_v9_secchi.csv") #has Secchi depth data
```

# Step 2. Define and filter data:

a) defining and filtering data for total algal biomass (as Chl-a)...

```{r}
Me_Chl<- Chl %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30"), #tells R to format field as Date
         Chla_ugL= tri_chl_spec, #renames field to common name with units
         Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j"))) %>% #renames field to common name
  filter(lakeid=="ME", #filter for Lake Mendota data
         depth_range_m=="0-8", #filter for data from integrated samples 0 to 8m
         rep=="1") %>% #remove QA analytic replicates
  filter(!is.na(Chla_ugL)) %>% #removes NAs in chl-a data
  select(sampledate, Yr, Chla_ugL, daynum) #selects only fields of interest
```

Chl-a data defined and filtered. 

b) defining and filtering data for cyanobacteria relative biovolume (CRB) and
cyanobacteria density (CD)...

```{r}
Me_cyanoRB<- phyto %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30")) %>% #tells R to format field as Datey
  filter(lakeid=="ME", #filter for Lake Mendota data
         depth_range=="0-8m", #filter for data from integrated samples 0 to 8m
         division=="Cyanophyta") %>% #filter for cyanobacteria data
  group_by(sampledate) %>% #group all observations by sample date
  summarize(relbiovol=sum(relative_total_biovolume), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(cells_per_ml)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(relbiovol<=100) %>% #remove any invalid records (>100%  not valid entry)   
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j")))  #adds field with day
```

CRB and CD data defined and filtered.

c) defining and filtering the Secchi depth data...

```{r}
Me_Secchi<- Secchi %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30"),#tells R to format field as Date
         SD_m=secnview) %>% #adds units to field
  filter(lakeid=="ME") %>% #filter for Lake Mendota data
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j"))) #adds field with day
```

# Step 3. View the data available:

a) Plotting Chl-a data available...

```{r}
ggplot(data=Me_Chl, aes(x=sampledate, y=Chla_ugL)) + #plots Chl-a across date
  geom_point() + #adds points at observations
  geom_line() + #adds lines between 
  theme_classic(base_size=12) +
  labs(x="Date", y="Total Chl-a (ug/L)")
```

Chl-a data plotted. Chl-a available from 2008 to 2012, note NAs in 2017.

b) Plotting CRB and CD data available...

```{r}
a<- ggplot(data=Me_cyanoRB, aes(x=sampledate, y=relbiovol))+
  geom_point() +  #point plot 
  geom_line() + #lines between points
  theme_classic(base_size=12)+
  labs(x="Date", y="Cyanobacteria Relative Biovolume 
       (as % total phytoplankton biovolume)")
b<- ggplot(data=Me_cyanoRB, aes(x=sampledate, y=CD_cellsmL/1000))+
  geom_point() +  #point plot 
  geom_line() + #lines between points
  theme_classic(base_size=12)+
  labs(x="Date", y="Cyanobacteria Density (10^3 cells/mL)")
a / b #plot a over plot b
```

CRB and CD data plotted. 

c) plotting Secchi depth (SD)...

```{r}
ggplot(data=Me_Secchi, aes(x=sampledate, y=SD_m)) + #plots Chl-a across date
  geom_point() + #adds points at observations
  geom_line() + #adds lines between 
  theme_classic(base_size=12) +
  scale_y_reverse() + #flips y axis to depth of lake
  labs(x="Date", y="Secchi disk depth (m)")
```

Secchi depth plotted. Note, y-axis reversed as limnological plot.

d) plotting Secchi depth and cyanobacteria relative biovolume to get cyanoHAB
season...

```{r}
Me_Secchi_fig3<- Me_Secchi %>%
  select(sampledate, SD_m) #select fields of interest
Me_cyanoRB_fig3<- Me_cyanoRB %>%
  select(sampledate, Yr, daynum, relbiovol) #selects fields of interest
Figure3_data<- merge(Me_Secchi_fig3, Me_cyanoRB_fig3, by=c("sampledate"),
                       all=TRUE) #merges data frames and keeps all records
write.csv(Figure3_data, file="Products/Figure3_data.csv")
a<- ggplot(data=Figure3_data, aes(x=daynum, y=SD_m)) + #plots SD across day
  geom_point() + #plots observations as points
  theme_classic(base_size=12) +
  scale_y_reverse() +
  geom_smooth() + #adds regression curve
  labs(x="Day of year", y="Secchi depth (m)") +
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=195, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=255, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
b <- ggplot(data=Figure3_data, aes(x=daynum, y=relbiovol)) + #plots cyano RB across day
  geom_point() + #plots observations as points
  theme_classic(base_size=12) +
  geom_smooth() + #adds regression curve
  labs(x="Day of year", 
       y="Cyanobacteria relative biovolume 
       (as % total phytoplankton biovolume)") +
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=195, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=255, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
a / b #plot a over plot b
ggsave("Products/Figure3_color.png") #saves plot to Products folder
```

Data plotted.

# Step 4. Bin observations into same daynumber each year:

a) defining expected observation frequencies...
```{r}
Yr<- seq(from=2012, #define year start of study period
             to=2018, #define year end of study period
             by=1) #creates a sequence every 1 year
Yr #prints the expected years of data
daynum_bins<- seq(from=196, #define date start of CyanoHAB season
                  to=252, #define date end of CyanoHAB season
                  by=14) #creates a sequence every 14 days 
daynum_bins #prints the expected observation dates of data
Me_phyto<- data.frame(Yr=rep(Yr, each=5), daynum_bin=rep(daynum_bins, times=7)) #create data frame with expected year and day number
```

Defined expected observation frequency.

b) binning Chl observed dates into expected dates...

```{r}
Me_Chl <- Me_Chl  %>%
  filter(Yr>=2012 & Yr<=2018) %>% #filter for study years
  filter(daynum >=189 & daynum <=259) %>% #filter for CyanoHAB season +- 7 days
  mutate(daynum_bin=
         ifelse(daynum<(daynum_bins[2]-7), #if observation is <= bin 2 min
                daynum_bins[1], #yes returns bin 1
                ifelse(daynum>=(daynum_bins[2]-7)&daynum<(daynum_bins[3]-7),
              #if observation is > bin 2 min and <= bin 3 min
              daynum_bins[2], #yes returns bin 2
              ifelse(daynum>=(daynum_bins[3]-7)&daynum<(daynum_bins[4]-7),
                     #if observation is > bin 3 min and <= bin 4 min
                     daynum_bins[3], #yes returns bin 3
                     ifelse(daynum>=(daynum_bins[4]-7)&daynum<(daynum_bins[5]-7),
                            #if observation is > bin 4 min and <= bin 5 min 
                            daynum_bins[4], #yes returns bin 4
                            daynum_bins[5])#no returns bin 5
                     )
              )
       ) 
)
Me_Chl<- Me_Chl %>% 
  filter(!duplicated(cbind(Yr, daynum_bin), fromLast = TRUE)) #remove first duplicate
```

Observed dates assigned to closest expected dates.

b) binning CD observed dates into expected dates...

```{r}
Me_cyanoRB <- Me_cyanoRB  %>% 
  filter(Yr>=2012 & Yr<=2018) %>% #filter for study years
  filter(daynum >=189 & daynum <=259) %>% #filter for CyanoHAB season +- 7 days
  mutate(daynum_bin=
         ifelse(daynum<(daynum_bins[2]-7), #if observation is <= bin 2 min
                daynum_bins[1], #yes returns bin 1
                ifelse(daynum>=(daynum_bins[2]-7)&daynum<(daynum_bins[3]-7),
              #if observation is > bin 2 min and <= bin 3 min
              daynum_bins[2], #yes returns bin 2
              ifelse(daynum>=(daynum_bins[3]-7)&daynum<(daynum_bins[4]-7),
                     #if observation is > bin 3 min and <= bin 4 min
                     daynum_bins[3], #yes returns bin 3
                     ifelse(daynum>=(daynum_bins[4]-7)&daynum<(daynum_bins[5]-7),
                            #if observation is > bin 4 min and <= bin 5 min 
                            daynum_bins[4], #yes returns bin 4
                            daynum_bins[5])#no returns bin 5
                     )
              )
       ) 
)
Me_cyanoRB<- Me_cyanoRB %>% 
  filter(!duplicated(cbind(Yr, daynum_bin), fromLast = TRUE)) #remove first duplicate
```

Observed dates assigned to closest expected dates.

c) merging the data frames...
Note, R only merges two data frames at one time.

```{r}
Me_phyto<- merge(Me_phyto, #x data frame
                 Me_Chl, #y data frame
                 by=c("Yr","daynum_bin"),
                 all.x=TRUE) #define the key fields
Me_phyto<- merge(Me_phyto, #x data frame
                 Me_cyanoRB, #y data frame
                 by=c("Yr","daynum_bin"),
                 all.x=TRUE) #define the key fields
```

Data merged.

# Step 5. Check for NAs, interpolate missing data values as needed:

```{r}
Me_phyto$Chla_ugL<- na.approx(Me_phyto$Chla_ugL) #interpolates NAs
Me_phyto$CD_cellsmL<- na.approx(Me_phyto$CD_cellsmL) #interpolates NAs
```

Missing values interpolated.

# Step 6. Summarize and view the data:

a) Plot Chl-a by day of year...

```{r}
ggplot(data=subset(Me_phyto, !Yr==2017), #note all data in 2017 were zeroed due 
       #to failing QA from source
       aes(x=daynum_bin,y=Chla_ugL)) + 
  geom_point()+ #adds points 
  geom_line() + #adds lines between points
  facet_wrap(~Yr) +
  labs(title="Epilimnion (depth <= 8 m) Lake Mendota, WI", #add title
       x="Day of Year", #add x axis label
       shape="Year", #add legend label as year
       y="Extracted Chl-a (ug/L)", #add y axis label
       caption="Color coding along y-axis indicates CyanoHAB severity (green = low, orange = moderate, red = severe).") + #add caption for notation
  theme_classic(base_size=12)+
  #scale_color_continuous(name="Year")+ #adds color scale for year
  annotate('rect', xmin=min(Me_phyto$daynum_bin), xmax=max(Me_phyto$daynum_bin), 
           ymin=0, ymax=12, alpha=.2, fill='green') + #low/no CyanoHAB
  annotate('rect', xmin=min(Me_phyto$daynum_bin), xmax=max(Me_phyto$daynum_bin), 
           ymin=12, ymax=50, alpha=.2, fill='orange')+ #moderate CyanoHAB
  annotate('rect', xmin=min(Me_phyto$daynum_bin), xmax=max(Me_phyto$daynum_bin), 
           ymin=50, ymax=Inf, alpha=.2, fill='red') #severe CyanoHAB
```

b) Plot CD by day of year...

```{r}
ggplot(data=Me_phyto, 
       aes(x=daynum_bin, y=CD_cellsmL)) + 
  geom_point()+ #colors points by year
  geom_line()+
  facet_wrap(~Yr) +
  labs(title = "Epilimnion (depth <= 8 m) Lake Mendota, WI", #adds title
       x="Day of Year", #adds x-axis label
       shape="Year",
       y="Cyanobacteria Density (cells/mL)", #adds y-xis label
       caption="Color coding along y-axis indicates CyanoHAB severity (green = low, orange = moderate, red = severe).") + #add caption for notation
  theme_classic(base_size=12)+
  #scale_color_continuous(name="Year")+ #adds color scale for year
  annotate('rect', xmin=min(Me_phyto$daynum_bin), xmax=max(Me_phyto$daynum_bin),
           ymin=0, ymax=20000, alpha=.2, fill='green') + #low/no CyanoHAB
  annotate('rect', xmin=min(Me_phyto$daynum_bin), xmax=max(Me_phyto$daynum_bin),
           ymin=20000, ymax=100000, alpha=.2, fill='orange')+ #moderate CyanoHAB
  annotate('rect', xmin=min(Me_phyto$daynum_bin), xmax=max(Me_phyto$daynum_bin),
           ymin=100000, ymax=Inf, alpha=.2, fill='red') #severe CyanoHAB
```

# Step 6. Save as new data file:

```{r}
write.csv(Me_phyto, file="Cleaned_data/cyanoHAB_severity.csv")
```