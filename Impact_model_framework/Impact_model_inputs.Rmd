---
title: "Impact_model_inputs.Rmd"
author: "Lauren Knose"
date: "2023-08-30"
output: html_document
editor_options: 
  chunk_output_type: console
---

The purpose of this program is to prepare data for input into models.


# Step 1. Load dependent packages and data needed:

a) Loading dependent packages...
```{r}
library(zoo) #needed to interpolate NA values (na.approx function)
```

b) Loading data...
Note, ensure date data is formatted in R as Date.

```{r}
Me_algae<- read.csv(file="Cleaned_data/cyanoHAB_severity.csv")
Me_extLoad<- read.csv(file="Cleaned_data/TotalP_allext.csv")
Me_intLoad<- read.csv(file="Cleaned_data/TotalP_allint.csv")
Me_hypoepiRatio<- read.csv(file="Cleaned_data/TotalP_water.csv")
```

# Step 2. Define and merge the data the data: 

a) defining data...

```{r}
Me_algae<- Me_algae %>%
  select(Yr, daynum_bin, Chla_ugL, CD_cellsmL) #select data needed
# Note, there are 5 observations (2017 data) that are zero (not-realistic). Data
# failed QC check and was set as zero by data originators. 
# Need to add 0.01 to zeros if log-transforming. 
Me_algae['Chla_ugL'][Me_algae['Chla_ugL']==0] <- 0.01 #replace the 0's in 2017 with 0.01
Me_extLoad<- Me_extLoad %>%
  mutate(ExtP_kgday=total) %>% #rename field with units
  select(Yr, daynum, ExtP_kgday) #select data needed
Me_intLoad <- Me_intLoad %>%
  select(Yr, daynum, Int_TotP_kgday) #select data needed
Me_hypoepiRatio<- Me_hypoepiRatio %>%
  mutate(HE_ratio=HE_ratio_TotP_mgL) %>% #rename field
  select(Yr, daynum, HE_ratio) #select data needed
```

Data defined.

b) merging data....
Note, you can only merge two files at one time.

```{r}
Me_all<- merge(Me_algae, Me_extLoad, 
               by.x=c("Yr", "daynum_bin"), #key fields in x data frame
               by.y=c("Yr", "daynum"), #key fields in y data frame
               all.x=TRUE) #only keep records in x data frame
Me_all<- merge(Me_all, Me_hypoepiRatio, 
               by.x=c("Yr", "daynum_bin"), #key fields in x data frame
               by.y=c("Yr", "daynum"), #key fields in y data frame
               all.x=TRUE) #only keep records in x data frame
Me_all<- merge(Me_all, Me_intLoad,
               by.x=c("Yr", "daynum_bin"), #key fields in x data frame
               by.y=c("Yr", "daynum"), #key fields in y data frame
               all.x=TRUE) #only keep records in x data frame
```

Data frames merged.

# Step 3. Interpolate weekly data:

a) building a data frame with weekly observations...
```{r}
Yr<- seq(from=2012, #define year start of study period
             to=2018, #define year end of study period
             by=1) #creates a sequence every 1 year
Yr #prints the expected years of data
daynum_bins<- seq(from=196, #define date start of CyanoHAB season
                  to=252, #define date end of CyanoHAB season
                  by=7) #creates a sequence every 14 days 
daynum_bins #prints the expected observation dates of data
Me_all_interp<- data.frame(Yr=rep(Yr, each=9), daynum_bin=rep(daynum_bins, times=7)) #create data frame with expected year and day number
```

Data frame with weekly observations created.

b) merging the observations with expected...

```{r}
Me_all_interp<- merge(Me_all_interp, #merge x data frame
                      Me_all, #with y data frame
                      by=c("Yr","daynum_bin"), #key fields
                      all.x=TRUE) #keep all rows in x data frame
```

Data merged.

c) interpolating missing values...

```{r}
Me_all_interp<- Me_all_interp %>%
  group_by(Yr) %>%
  mutate(Chla_ugL_interp=na.approx(Chla_ugL, na.rm=FALSE),
         CD_cellsmL_interp=na.approx(CD_cellsmL, na.rm=FALSE),
         ExtP_kgday_interp=na.approx(ExtP_kgday, na.rm=FALSE),
         HE_ratio_interp=na.approx(HE_ratio, na.rm=FALSE),
         IntP_kgday_interp=na.approx(Int_TotP_kgday, na.rm=FALSE)) %>%
  ungroup()
```

Missing values interpolated.

# Step 4. Describe data:

checking for normality...

```{r}
write.csv(Me_all_interp, file="Products/Figure13_data.csv")
png(file="Products/Figure13.png", width=1000,height=500)
layout(matrix(c(1,2, 3, 4, 5, 6, 7, 8, 9, 10), #make a matrix of plots
              2)) #2 rows and 4 columns
hist(Me_all_interp$Chla_ugL_interp, breaks=25,#histograph of Chl-a
     main="non-transformed",
     xlab="Chl-a (ug/L)") 
#data right skewed
hist(log10(Me_all_interp$Chla_ugL_interp), breaks=25,#histograph of log10(Chl-a)
     main="log-transformed",
     xlab="Chl-a (ug/L)") 
#log-transform data is more normal
hist(Me_all_interp$CD_cellsmL_interp, breaks=25,#histograph of CD
     main="non-transformed",
     xlab="CD (cells/mL)") 
#data relatively normal
hist(log10(Me_all_interp$CD_cellsmL_interp), breaks=25,#histograph of log10(CD)
     main="log-transformed",
     xlab="CD (cells/mL)") 
#log-transform data still normal
hist(Me_all_interp$ExtP_kgday_interp, breaks=25,#histogrpah of P_ext
     main="non-transformed",
     xlab="P_ext (kg/day)") 
#data right skewed
hist(log10(Me_all_interp$ExtP_kgday_interp), breaks=25,#histograph of log10(P_ext)
     main="log-transformed",
     xlab="P_ext (kg/day)") 
#log-transform data more normal
hist(Me_all_interp$IntP_kgday_interp, breaks=25,#histograph of P_int
     main="non-transformed",
     xlab="P_int (kg/day)") 
#data relatively normal
hist(log10(Me_all_interp$IntP_kgday_interp), breaks=25,#histograph of log10(P_int)
     main="log-transformed",
     xlab="P_int (kg/day)") 
#log-transform data is still normal
hist(Me_all_interp$HE_ratio_interp, breaks=25,#histograph of P_hypo_epi
     main="non-transformed",
     xlab="P_hypo:P_epi") 
#data right-skewed
hist(log10(Me_all_interp$HE_ratio_interp), breaks=25,#histograph of log10(P_hypo:epi) 
     main="log-transformed",
     xlab="P_hypo:P_epi") 
#log-transform data more normal
dev.off()
par(mfrow=c(1,1))#returns graphing viewer to 1 plot per page
```

Data that needs to be log-transformed is Chl-a, P_ext, and P_hypo:epi, prior to modeling.

# Step 5. Determine the appropriate lag for predictor variables:

a) checking lags for Chl-a_t-k...

```{r}
Me_Chla_k<- transform(Me_all_interp, 
                     Chla_ugL_k7=lag(Chla_ugL_interp, n=1), #adds field holding value 7 days before
                     Chla_ugL_k14=lag(Chla_ugL_interp, n=2), #adds field holding value 14 days before
                     Chla_ugL_k21=lag(Chla_ugL_interp, n=3), #adds field holding value 21 days before
                     Chla_ugL_k28=lag(Chla_ugL_interp, n=4)) #adds field holding value 28 days before

regk_Chla<- glm(formula=log10(Chla_ugL_interp) ~ #response variable
               log10(Chla_ugL_k7), #vary the k to print the regressions
              data=Me_Chla_k) #data frame
summary(regk_Chla)#prints the glm output
aov(regk_Chla)#prints the sum of squares for the regression and residuals
```                     

The lag of best fit for Chl-a_t-k, was chosen as k=7 days.

```{r}
Me_Pext_k<- transform(Me_all_interp, 
                     Pext_k7=lag(ExtP_kgday_interp, n=1), #adds field holding value 7 days before
                     Pext_k14=lag(ExtP_kgday_interp, n=2), #adds field holding value 14 days before
                     Pext_k21=lag(ExtP_kgday_interp, n=3), #adds field holding value 21 days before
                     Pext_k28=lag(ExtP_kgday_interp, n=4)) #adds field holding value 28 days before

regk_Pext<- glm(formula=log10(Chla_ugL_interp) ~ #response variable
               log10(Pext_k28), #vary the k to print the regressions
              data=Me_Pext_k) #data frame
summary(regk_Pext)#prints the glm output
aov(regk_Pext)#prints the sum of squares for the regression and residuals
```     

The lag of best fit for P_ext,t-k, was chosen as k=28 days.

```{r}
Me_Pint_k<- transform(Me_all_interp, 
                     Pint_k7=lag(IntP_kgday_interp, n=1), #adds field holding value 7 days before
                     Pint_k14=lag(IntP_kgday_interp, n=2), #adds field holding value 14 days before
                     Pint_k21=lag(IntP_kgday_interp, n=3), #adds field holding value 21 days before
                     Pint_k28=lag(IntP_kgday_interp, n=4)) #adds field holding value 28 days before

regk_Pint<- glm(formula=log10(Chla_ugL_interp) ~ #response variable
               Pint_k28, #vary the k to print the regressions
              data=Me_Pint_k) #data frame
summary(regk_Pint)#prints the glm output
aov(regk_Pint)#prints the sum of squares for the regression and residuals
```     

The lag of best fit for P_int,t-k, was chosen as k=28 days.

```{r}
Me_Pratio_k<- transform(Me_all_interp, 
                     Pratio_k7=lag(HE_ratio_interp, n=1), #adds field holding value 7 days before
                     Pratio_k14=lag(HE_ratio_interp, n=2), #adds field holding value 14 days before
                     Pratio_k21=lag(HE_ratio_interp, n=3), #adds field holding value 21 days before
                     Pratio_k28=lag(HE_ratio_interp, n=4)) #adds field holding value 28 days before

regk_Pratio<- glm(formula=log10(Chla_ugL_interp) ~ #response variable
               log10(Pratio_k28), #vary the k to print the regressions
              data=Me_Pratio_k) #data frame
summary(regk_Pratio)#prints the glm output
aov(regk_Pratio)#prints the sum of squares for the regression and residuals
```    

The lag of best fit for P_HEratio, t-k, was chosen as k=28 days.

b) checking lags for CD_t-k...

```{r}
Me_CD_k<- transform(Me_all_interp, 
                     CD_cellsmL_k7=lag(CD_cellsmL_interp, n=1), #adds field holding value 7 days before
                     CD_cellsmL_k14=lag(CD_cellsmL_interp, n=2), #adds field holding value 14 days before
                     CD_cellsmL_k21=lag(CD_cellsmL_interp, n=3), #adds field holding value 21 days before
                     CD_cellsmL_k28=lag(CD_cellsmL_interp, n=4)) #adds field holding value 28 days before

regk_CD<- glm(formula=log10(CD_cellsmL_interp) ~ #response variable
               log10(CD_cellsmL_k28), #vary the k to print the regressions
              data=Me_CD_k) #data frame
summary(regk_CD)#prints the glm output
aov(regk_CD)#prints the sum of squares for the regression and residuals
```                     

The lag of best fit was chosen as k=7 days for CD_t-k.

```{r}
Me_Pext_k<- transform(Me_all_interp, 
                     Pext_k7=lag(ExtP_kgday_interp, n=1), #adds field holding value 7 days before
                     Pext_k14=lag(ExtP_kgday_interp, n=2), #adds field holding value 14 days before
                     Pext_k21=lag(ExtP_kgday_interp, n=3), #adds field holding value 21 days before
                     Pext_k28=lag(ExtP_kgday_interp, n=4)) #adds field holding value 28 days before

regk_Pext<- glm(formula=log10(CD_cellsmL_interp) ~ #response variable
               log10(Pext_k28), #vary the k to print the regressions
              data=Me_Pext_k) #data frame
summary(regk_Pext)#prints the glm output
aov(regk_Pext)#prints the sum of squares for the regression and residuals
```                     

The lag of best fit was chosen as k=28 days for P_ext,t-k.
                
```{r}
Me_Pint_k<- transform(Me_all_interp, 
                     Pint_k7=lag(IntP_kgday_interp, n=1), #adds field holding value 7 days before
                     Pint_k14=lag(IntP_kgday_interp, n=2), #adds field holding value 14 days before
                     Pint_k21=lag(IntP_kgday_interp, n=3), #adds field holding value 21 days before
                     Pint_k28=lag(IntP_kgday_interp, n=4)) #adds field holding value 28 days before

regk_Pint<- glm(formula=log10(CD_cellsmL_interp) ~ #response variable
               Pint_k28, #vary the k to print the regressions
              data=Me_Pint_k) #data frame
summary(regk_Pint)#prints the glm output
aov(regk_Pint)#prints the sum of squares for the regression and residuals
```                     

The lag of best fit was chosen as k=28 days for P_int, t-k.

```{r}
Me_Pratio_k<- transform(Me_all_interp, 
                     Pratio_k7=lag(HE_ratio_interp, n=1), #adds field holding value 7 days before
                     Pratio_k14=lag(HE_ratio_interp, n=2), #adds field holding value 14 days before
                     Pratio_k21=lag(HE_ratio_interp, n=3), #adds field holding value 21 days before
                     Pratio_k28=lag(HE_ratio_interp, n=4)) #adds field holding value 28 days before

regk_Pratio<- glm(formula=log10(CD_cellsmL_interp) ~ #response variable
               log10(Pratio_k28), #vary the k to print the regressions
              data=Me_Pratio_k) #data frame
summary(regk_Pratio)#prints the glm output
aov(regk_Pratio)#prints the sum of squares for the regression and residuals
```                     

The lag of best fit was chosen as k=28 days for P_ratio, t-k.


c) computing lag values and add to data file...

```{r}
Me_all_interp<- Me_all_interp %>%
  mutate(Chla_ugL_interp_k7=lag(Chla_ugL_interp, n=1),
         CD_cellsmL_interp_k7=lag(CD_cellsmL_interp, n=1),
         ExtP_kgday_interp_k28=lag(ExtP_kgday_interp, n=4),
         IntP_kgday_interp_k28=lag(IntP_kgday_interp, n=4),
         HE_ratio_interp_k28=lag(HE_ratio_interp, n=4))
```

Lagged data computed and added to new data frame. 

# Step 6. Save as new data file:

```{r}
write.csv(Me_all_interp, file="Cleaned_data/Impact_model_input_data.csv")
```

Merged file saved as "Impact_model_input_data.csv" in Clean_data folder.