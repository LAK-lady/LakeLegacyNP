---
title: "Mendota_MassBalances_Spring"
author: "Lauren A. Knose, ORISE-EPA"
date: '2023-02-28'
output: html_document
---

The purpose of this program is to calculate the mass balances for each pool of 
Phosphorus (P) in Lake Mendota, WI, during the Summer. 

Step 1. set working directory and load dependent packages:

```{r}
setwd("~/ORISE_EPA_LKnose/Analysis/GitHub/LakeLegacyNP")
library(ggplot2) #needed for plots
library(dplyr) #needed for reshaping/reformaing data
library(zoo)
library(lubridate) #needed for reformatting data
library(DiagrammeR) #needed for conceptual model
#library(hrbrthemes) #needed for ridge plot
#library(viridis) #needed for ridge plot
#library(ggridges) #needed for ridge plot
```

Below is the conceptual model for a summer, stratified lake (assuming P doesn't 
change in metalimnion) and the flux of P in and out. From my volume calculations, 
I learned that the Secchi disk depth, on average, doesn't significantly change 
from day 195 (mid-July) to day 255 (mid-September). This means I should use this
Julian date range to calculate my summer mass balances, because the volumes can 
also be assumed to not change during this time. 

``` {r}
grViz("
digraph SEM {

graph [layout = dot,
       overlap = false, fontsize = 20]

node [shape = rectangle]

a [label = 'External Load', shape = oval]
b [label = 'External Export', shape = oval]
c [label = 'Epilimnion']
d [label = 'Hypolimnion']
e [label = 'Sediments']
f [label = 'Permanent Burial', shape = oval]
a->c
c->b
c->d [label = 'Settling']
d->c [label = '    Entrainment']
d->e [label = 'Settling']
e->d [label = '   Internal Load']
e->f 
}
")
```

Step 2. Load the data into R: 

```{r}
NTL_chem<-read.csv(file.choose()) # choose ntl1_v9_1_chem.csv to load the 
  #nutrient dataset
```

A little background about the data set:
This data is open-source, downloaded from the North Temperate Lakes project,
led by Dr. Paul Hanson of University of Wisconsin. The project is funded by NSF
Long Term Ecological Research (ROR: 04gq8q482). There are several lakes included 
in the data set. At this time, we are interested in data from Lake Mendota, WI, 
which has an average depth of 12.8m and a maximum depth of 25.3m. The surface 
area of the lake is 39.4 km^2, the volume is 5x10^8 m^3, and the residence time 
is 4.5 years. 
Data is aggregated for depths 0 - 2m (near surface) or 0 - 8m (epilimnion). 


Step 3. Filter and transform data:

```{r}
spr_ME_TP<- NTL_chem %>%
  filter(lakeid=="ME") %>% #filter for only Lake Mendota data
  filter(rep=="1") %>% #filter for only rep 1 data
  filter(daynum>=67 & daynum < 181) %>% #filter the data to summer HAB season
  select(year4, daynum, sampledate, depth,totpuf_sloh) %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30")) #tells R to format 
          #data as date
```

TP is collected at the following depths in meters from the surface: 
`r unique(sum_ME_TP$depth)`. Since the compensation depth 
is 3.5 m, I can use the 0m concentrations for the epilimnion. However, for the 
hypo, I have to deal with 17 different depths.  

```{r}
epi_spr_ME_TP <- spr_ME_TP %>%
  filter(depth=="0") %>% #filter for measurements taken from 0m
  select(-depth) #remove the depth field because they should all be 0
write.csv(epi_spr_ME_TP, file="epi_spr_ME_TP.csv")
## performed further clean-up of data in excel --> see lab notes for 2/28/2023
```

```{r}
hypo_spr_ME_TP <- spr_ME_TP %>%
  filter(depth > "0") %>% #filter for measurements taken > 0m
  group_by(sampledate) %>% #group all observations taken on same sample date
  summarise(mean_hypo_TP= mean(totpuf_sloh, na.rm=TRUE), #calculate mean
            sd_hypo_TP= sd(totpuf_sloh, na.rm=TRUE)) %>% #calculate stdev
  mutate(year4=year(ymd(sampledate)),
         daynum=format(sampledate, "%j")) #adds back the field with Julian day
write.csv(hypo_spr_ME_TP, file="hypo_spr_ME_TP.csv")#filter for measurements 
## taken from 0m, performed further clean-up of data in excel 
## --> see lab notes for 2/15/2023
```

An important thing to keep in mind is that sampling may not occur exactly on a
regular schedule, due to inclement weather, access issues, or personnel available.
If measurements were taken bimonthly from 1995 to 2018 (24 years), there should 
be observation for around Mar 15, Mar 30, Apr 15, Apr 30, May 15, May 30, June 15, 
and Jun 30. 
I should have 8 observations per year * 24 years for a total of 192 observations. 
Since I don't have a matching number of records, this means I do not have the 
same number of observations for each year. In order to do time series, I need to 
have consistent time periods between observations. To solve this challenge I need 
to go through each year and assign the approximate Julian day and interpolate 
any missing values. I exported the data to Excel, added a new column "Use_Jdate" 
with either 196, 211, 227, 242, or 258. I then performed a linear regression of 
the data from each year there was a missing observation and added the estimated
value. I performed this protocol for epi TP, epi SRP, hypo TP, and hypo SRP.

```{r}
epi_spr_ME_TP <- read.csv(file.choose(), header=TRUE) # select the csv file
## from Cleaned_data folder 
## I now have all complete cases
hypo_spr_ME_TP <- read.csv(file.choose(), header=TRUE) # select the csv file
## from Cleaned_data folder 
## I now have all complete cases
```

Now, I have an equal number of observations for each of my response variables. 
I can add the Spring TP data to the Summer TP data

Step 4.  Summarize and view the data:

```{r}
epi_sum_ME_TP$mo=NULL #removes unwanted columns
epi_sum_ME_TP$yr_mo=NULL #removes unwanted columns
epi_TP_sprsum<- rbind(epi_spr_ME_TP, epi_sum_ME_TP) #adds the rows together 
ggplot(data=epi_TP_sprsum, aes(Use_Jdate, totpuf_sloh)) + 
  geom_point() + #makes a scatterplot
  geom_line() + #makes line plot
  facet_wrap(~year4) + 
  theme_classic() + #color graph as classic figure
  labs(x="Day of Year", y=" Total P (mg/L)",#adds axis labels
       title="Epilimnion, Lake Mendota, WI",
       caption="Source: Lake Mendota,North Temperate Lakes Dataset")
```

```{r}
ggplot(data=epi_TP_sprsum, aes(Use_Jdate, totpuf_sloh, color=as.factor(year4))) + 
  geom_point() +
  geom_smooth(method="loess") + 
  theme_classic() +
  theme(legend.justification=c("right", "top")) +
  labs(x="Day of Year", y=" Total P (mg/L)",#adds axis labels
       title="Epilimnion, Lake Mendota, WI",
       caption="Source: Lake Mendota,North Temperate Lakes Dataset")
```

```{r}
hypo_sum_ME_TP$mo=NULL #removes unwanted columns
hypo_TP_sprsum <- rbind(hypo_spr_ME_TP, hypo_sum_ME_TP) #adds the rows together 
ggplot(data=hypo_TP_sprsum, aes(Use_Jdate, mean_hypo_TP)) + 
  geom_point() + #makes a scatterplot
  geom_line() + #makes line plot
  facet_wrap(~year4) + 
  theme_classic() + #color graph as classic figure
  labs(x="Day of Year", y=" Total P (mg/L)",#adds axis labels
       title="Hypolimnion, Lake Mendota, WI",
       caption="Source: Lake Mendota,North Temperate Lakes Dataset")
```
```{r}
ggplot(data=hypo_TP_sprsum, aes(Use_Jdate, mean_hypo_TP, color=as.factor(year4))) + 
  geom_point() +
  geom_line() + 
  theme_classic() +
  theme(legend.justification=c("right", "top")) +
  labs(x="Day of Year", y=" Total P (mg/L)",#adds axis labels
       title="Hypolimnion, Lake Mendota, WI",
       caption="Source: Lake Mendota,North Temperate Lakes Dataset")
```