---
title: "Mendota_Pexternal_outflow"
author: "Lauren Knose"
date: "2023-07-25"
output: html_document
---

The purpose of this program is to calculate total external P export from outflow.


# Step 1. Load dependent packages and data needed:

a) Loading dependent packages...
```{r}
library(ggplot2) #needed for plots
library(ggbreak) #needed for plot scale breaks
library(dplyr) #needed for reshaping/reformaing data
library(lubridate) #needed for date functions
library(zoo) #needed to interpolate data
library(xts) #needed to convert data frame to time series
```

Packages loaded.

b) Loading dependent data....

```{r}
outflow<- read.csv(file="Original_data/Mendota_Export_Tenneydam.csv") 
totP_epi<- read.csv(file="Cleaned_data/Mendota_P_water.csv")
```

Data loaded.

# Step 2. Transform and merge data:

a) transforming data...

```{r}
lb_kg= 0.453592/1 #conversion factor from lb to kg (1lb = 0.453592 kg)
cf_L= 1/0.0353147 #conversion factor from ft^3 to L (1 ft^3 = 28.3168 L)
sec_day= 86400/1 #conversion factor from sec to day (86400 sec = 1 day)
mg_kg= 1/1000000 #conversion factor from mg to kg (1,000,000 mg = 1 kg)

outflow2<- outflow %>%
  select(datetime, Q_cfs) %>%
  mutate(sampledate=as.Date(datetime, origin="1899-12-30", format="%m/%d/%Y"),
         datetime=NULL) %>%
  filter(Q_cfs>=0) %>% #remove any records where there is a negative flow rate
  mutate(Q_Lday=(Q_cfs*cf_L*sec_day), #convert cf/s to L/day
         Q_cfs=NULL) #remove excess column

totP_epi2<- totP_epi %>%
  select(sampledate, Epi_TotP_mgL) %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30"),
         TotP_kgL = Epi_TotP_mgL*mg_kg,
         Epi_TotP_mgL=NULL) #convert mg/L to kg/K
```

Data transformed.

b) Merging the data:

```{r}
Outflow_P<- merge(outflow2, totP_epi2, #merge two data frames
                by="sampledate") #key field is sampledatae
```

Data merged.

c) Calculate total P export from outflow:

```{r}
Outflow_P<- Outflow_P %>%
  mutate(TotP_kgday=Q_Lday*TotP_kgL, #calculates the total P (kg/day)
         Q_Lday=NULL, #removes excess field
         TotP_kgL=NULL) #removes excess field
```

Total P export calculated by sample date.

# Step 3. View and summarize the data:

a) viewing data available for the outflow...

```{r}
plot(Outflow_P$sampledate, Outflow_P$TotP_kgday, 
     xlab = "Sample Date", ylab = "Total P Export (kg/day)", 
     main = "Tenney Dam Outflow", cex.lab=1.5, cex.main=2, cex.axis=2)
```

Data available from November 2003 to November 2018. 

b) Plot data by daynum (season)...

```{r}
Outflow_P <-Outflow_P %>%
  mutate(daynum=as.integer(format(sampledate, format="%j")),
         Yr=as.integer(format(sampledate, format="%Y")))

ggplot(data=Outflow_P, 
       aes(x=daynum, 
           y=TotP_kgday)) +
  geom_line()+
  theme_classic()+
  labs(y="Daily Total P export (kg/day)",
       x="Day of Year",
      caption="White highlight indicates CyanoHAB season, mid-July to mid-Sept.") +
  ylim(c(0, max(Outflow_P$TotP_kgday))) +
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=195, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=255, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
```

c) Summarizing data for CyanoHAB season...
```{r}
Outflow_P %>%
  filter(daynum>= 195 & daynum <=255) %>%
  summarise(mean=mean(TotP_kgday, na.rm=TRUE),
            se=(sd(TotP_kgday, na.rm=TRUE)/sqrt(length(TotP_kgday))),
            min=min(TotP_kgday, na.rm=TRUE),
            max=max(TotP_kgday, na.rm=TRUE))
```


c) plotting total P export by year...

```{r}
Outflow_sumP_yr<- Outflow_P %>%
  group_by(Yr) %>% #group all records by year
  summarise(sum_TP_kg=sum(TotP_kgday)) #calculate the total P load 

Outflow_sumP_yr %>%
  summarise(mean=mean(sum_TP_kg, na.rm=TRUE),
            se=(sd(sum_TP_kg, na.rm=TRUE)/sqrt(length(sum_TP_kg))),
            min=min(sum_TP_kg, na.rm=TRUE),
            max=max(sum_TP_kg, na.rm=TRUE))

ggplot(Outflow_sumP_yr, aes(x=as.factor(Yr), y=sum_TP_kg)) +
  geom_col() +
  theme_classic() +
  labs(x="Year", y="Total P export from outflow (kg)") 
```

Total P load plotted by year.

# Step 4. Save new data file.

```{r}
write.csv(Outflow_P, file="Cleaned_data/Mendota_P_outflow.csv") #save as new data file
```
