---
title: "Manuscript_plots.Rmd"
author: "Lauren Knose"
date: "2023-08-29"
output: html_document
editor_options: 
  chunk_output_type: console
---

The purpose of this program is to provide the code for producing figures for the
manuscript on legacy nutrient pollution.

# Figure 1: R model framework.
This figure was produced in Microsoft PowerPoint and saved as a jpeg file.

# Figure 2. Python model framework.
This figure was produced in Microsoft PowerPoint and saved as a jpeg file. 

# Figure 3: Average daily Secchi disk depth and cyanobacteria relative biomass.

## a) loading dependent data and packages...

```{r}
library(ggplot2) #needed for plotting
library(dplyr) #needed for reformatting data
Secchi<- read.csv(file="Original_data/ntl31_v9_secchi.csv") #Secchi depth data
phyto<-read.csv(file="Original_data/ntl88_v13_phytoplankton.csv", header=TRUE) #has the phytoplankton community dataset
```

Data and packages loaded.

## b) reformatting data for plotting...

```{r}
Me_Secchi<- Secchi %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30")) %>% #tells R to format field as Datey
  filter(lakeid=="ME") %>% #filter for Lake Mendota data
  select(sampledate, secnview) %>% #select fields of interest
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j"))) #adds field with day

Me_cyanoRB<- phyto %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30")) %>% #tells R to format field as Datey
  filter(lakeid=="ME", #filter for Lake Mendota data
         depth_range=="0-8m", #filter for data from integrated samples 0 to 8m
         division=="Cyanophyta") %>% #filter for cyanobacteria data
  group_by(sampledate) %>% #group all observations by sample date
  summarize(relbiovol=sum(relative_total_biovolume)) %>% #sums all cyano biovol
  filter(relbiovol<=100) %>% #remove any invalid records (>100%  not valid entry)   
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j"))) #adds field with day
Figure3_data<- merge(Me_Secchi, Me_cyanoRB, by=c("sampledate","Yr","daynum"),
                       all=TRUE)
write.csv(Figure3_data, file="Products/Figure3_data.csv")
```

Data reformatted.

## c) plotting data...

```{r}
a<- ggplot(data=Figure3_data, aes(x=daynum, y=secnview)) + #plots SD across day
  geom_point(shape=1) + #plots observations as points
  theme_classic(base_size=12) +
  geom_smooth() + #adds regression curve
  labs(x="Day of year", y="Secchi depth (m)") +
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=195, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=255, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
b <- ggplot(data=Figure3_data, aes(x=daynum, y=relbiovol)) + #plots cyano RB across day
  geom_point(shape=17) + #plots observations as triangles
  theme_classic(base_size=12) +
  geom_smooth() + #adds regression curve
  labs(x="Day of year", 
       y="Cyanobacteria relative biovolume 
       as % total phytoplankton biovolume)") +
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=-Inf, xmax=195, ymin=0, ymax=Inf) +#shadow box highlights CyanoHAB season
  annotate('rect', fill='gray60', alpha=.2, #creates a shadow box 
           xmin=255, xmax=Inf, ymin=0, ymax=Inf)  #shadow box highlights CyanoHAB season
a / b #plot a over plot b
ggsave("Products/Figure3_color.png")
```

Data plotted.

# Figure 4. Bathymetry map of Lake mendota and water column.
This figure was produced in Microsoft PowerPoint and saved as a jpeg file. 

# Figure 5. Variability in cyanoHAB severity (as Chl-a) explained.


# Figure 6. Variability in cyanoHAB severity (as cyanobacteria density) explained.


# Figure 7. Annual internal legacy total P load (kg-year-1) 

# Figure 8. Annual external total P load (kg-year-1) 

# Figure 9. Total P loading for the three main inflows of Lake Mendota, WI (USA)


# Figure 10. Ratio of total P concentration between hypolimnion and epilimnion 
```{r}
library(plotly) #needed for interactive 3D plot
library(dplyr) #needed for defining data
Me_P_water<- read.csv(file="Cleaned_data/TotalP_water.csv") # water P data
Me_P_ratio <- Me_P_water %>%
  filter(Yr>= 2012 & Yr<= 2018) %>% #filter for study period
  select(Yr, daynum, HE_ratio_TotP_mgL) #select only the 
write.csv(Me_P_ratio, file="Products/Figure10_data.csv")
fig10<- plot_ly(x=Me_P_ratio$Yr, #creates 3D plot with year as x axis
               y=Me_P_ratio$daynum, #day of year as y axis
               z=Me_P_ratio$HE_ratio_TotP_mgL, #P_hypo:P_epi as z axis
               type="scatter3d", mode="markers", #values as points
               color=Me_P_ratio$HE_ratio_TotP_mgL) #colors points by value
fig10<- fig10 %>%
  layout(scene=list(xaxis=list(title="Year", tickfont=list(size=12)),
                    yaxis=list(title="Day of Year", tickfont=list(size=12)),
                    zaxis=list(title="Total P hypo:epi", tickfont=list(size=12))
                    )
         )
fig10
```

# Figure 11. Optimized hot spot analysis of total P
This figure was produced in ESRI ArcGIS Pro and saved as a jpeg file. 

# Figure 22: 3D plot of Chl-a across day number and year...
```{r}
library(plotly) #needed for interactive 3D plot
library(dplyr) #needed for defining data

Chl<- read.csv(file="Original_data/ntl38_v5_chl.csv", header=TRUE)

Me_Chl<- Chl %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30"), #tells R to format field as Date
         Chla_ugL= tri_chl_spec, #renames field to common name with units
         ) %>% 
  filter(lakeid=="ME", #filter for Lake Mendota data
         depth_range_m=="0-8", #filter for data from integrated samples 0 to 8m
         rep=="1") %>% #remove QA analytic replicates
  filter(!is.na(Chla_ugL)) %>% #removes NAs in chl-a data
  select(sampledate, Chla_ugL) #selects only fields of interest

date_range<- seq( #creates a vector of sequence data
  min(Me_Chl$sampledate), #starting at the first sample date
  max(Me_Chl$sampledate), #ending at the last sample date
  by="1 day") #observations every day  
interpolated<- approx( #creates a vector of data that linearly interpolates 
  Me_Chl$sampledate, #across date
  Me_Chl$Chla_ugL, #the predicted values of Chl-a
  xout=date_range) #for every 1 day
Chla_interp <- data.frame( #creates a new data frame that has 
  sampledate = as.Date(interpolated$x), #renames the new vector as common field 
  Chla_ugL=interpolated$y) #renames the new vector as common field with units

Chla_interp<- Chla_interp %>%
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #adds field with year
         daynum=as.numeric(format(sampledate, "%j")) #adds field with day of yr
         ) %>%
  filter(Yr>=2012 & Yr<=2018) #filter for study period

fig22<- plot_ly(x=Chla_interp$Yr, 
  y=Chla_interp$daynum, 
  z=Chla_interp$Chla_ugL, 
  type="scatter3d", mode="markers",
  color=Chla_interp$Chla_ugL)
fig22<- fig22 %>%
  layout(scene=list(xaxis=list(title="Year"),
         yaxis=list(title="Day of Year"),
         zaxis=list(title="Chlorophyll-a (ug/L)")))
fig22
```


# Figure 23: 3D plot of CD across day number and year...
```{r}
library(plotly) #needed for interactive 3D plot
library(dplyr) #needed for defining data

phyto<-read.csv(file="Original_data/ntl88_v13_phytoplankton.csv", header=TRUE) #has the phytoplankton community dataset

Me_cyanoRB<- phyto %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30")) %>% #tells R to format field as Datey
  filter(lakeid=="ME", #filter for Lake Mendota data
         depth_range=="0-8m", #filter for data from integrated samples 0 to 8m
         division=="Cyanophyta") %>% #filter for cyanobacteria data
  group_by(sampledate) %>% #group all observations by sample date
  summarize(relbiovol=sum(relative_total_biovolume), #add all observations of cyanobacteria biovolumes together for each sample date
            CD_cellsmL=sum(cells_per_ml)) %>% #adds all the cyanobacteria cells/mL together for each sample date
  filter(relbiovol<=100) %>% #remove any invalid records (>100%  not valid entry)   
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #renames field
         daynum=as.numeric(format(sampledate, "%j"))) %>% #adds field with day
  filter(Yr>=2012 & Yr<=2018) #filter for study years

date_range<- seq( #creates a vector of sequence data
  min(Me_cyanoRB$sampledate), #starting at the first sample date
  max(Me_cyanoRB$sampledate), #ending at the last sample date
  by="1 day") #observations every day  
interpolated<- approx( #creates a vector of data that linearly interpolates 
  Me_cyanoRB$sampledate, #across date
  Me_cyanoRB$CD_cellsmL, #the predicted values of Cyanos
  xout=date_range) #for every 1 day
CD_interp <- data.frame( #creates a new data frame that has 
  sampledate = as.Date(interpolated$x), #renames the new vector as common field 
  CD_cellsmL=interpolated$y) #renames the new vector as common field with units

CD_interp<- CD_interp %>%
  mutate(Yr=as.numeric(format(sampledate, "%Y")), #adds field with year
         daynum=as.numeric(format(sampledate, "%j")) #adds field with day of yr
         ) %>%
  filter(Yr>=2012 & Yr<=2018) #filter for study period

fig23<- plot_ly(x=CD_interp$Yr, 
  y=CD_interp$daynum, 
  z=CD_interp$CD_cellsmL, 
  type="scatter3d", mode="markers",
  color=CD_interp$CD_cellsmL)
fig23<- fig23 %>%
  layout(scene=list(xaxis=list(title="Year"),
         yaxis=list(title="Day of Year"),
         zaxis=list(title="Cyanobacteria Density (cells/mL)")))
fig23
```




# 3D plot of Chl-a against P_ext and P_int...

```{r}
library(plot3D) #needed for scatter3D plot
Me_all_interp<- read.csv(file="Cleaned_data/Mendota_modeldata.csv")
scatter3D(x=Me_all_interp$ExtP_kgday_interp, 
  y=Me_all_interp$IntP_kgday_interp, 
  z=(Me_all_interp$Chla_ugL_interp), bty="g", pch=20, cex=2, ticktype="detailed",
  xlab="Total P external load (kg/day)", 
  ylab="Total P internal load (kg/day)", 
  zlab="Total Chl-a (ug/L)")
```

# 3D plot of Chl-a against P_ext and P_hypo:epi...

```{r}
library(plot3D) #needed for scatter3D plot
Me_all_interp<- read.csv(file="Cleaned_data/Mendota_modeldata.csv")
scatter3D(x=Me_all_interp$ExtP_kgday_interp, 
  y=Me_all_interp$HE_ratio_interp, 
  z=Me_all_interp$Chla_ugL_interp, bty="g", pch=20, cex=2, ticktype="detailed",
  xlab="Total P external load (kg/day)", 
  ylab="Total P Ratio Hypo: Epi", 
  zlab="Total Chl-a (ug/L)")
```

d) plotting CD against P_ext and P_int...

```{r}
scatter3D(x=Me_all_interp$ExtP_kgday_interp, 
  y=Me_all_interp$IntP_kgday_interp, 
  z=Me_all_interp$CD_cellsmL_interp, bty="g", pch=20, cex=2, ticktype="detailed",
  xlab="Total P external load (kg/day)", 
  ylab="Total P internal load (kg/day)", 
  zlab="Cyanobacteria density (cells/mL)")
```

e) plotting CD against P_ext and P_hypo:epi...

```{r}
scatter3D(x=Me_all_interp$ExtP_kgday_interp, 
  y=Me_all_interp$HE_ratio_interp, 
  z=Me_all_interp$CD_cellsmL_interp, bty="g", pch=20, cex=2, ticktype="detailed",
  xlab="Total P external load (kg/day)", 
  ylab="Total P Ratio Hypo: Epi", 
  zlab="Cyanobacteria density (cells/mL)")
```
