---
title: "Mendota_Modeling.Rmd"
author: "Lauren A. Knose, ORISE-EPA"
date: '2023-06-23'
output: html_document
---

The purpose of this program is to perform an impact analysis comparing the internal vs external loading on changes in Chl-a and CyanoDensity.


# Step 1. Load dependent packages and data needed:

a) Loading dependent packages...
```{r}
library(ggplot2) #needed for plots
library(ggbreak) #needed for plot scale breaks
library(dplyr) #needed for reshaping/reformating data
library(rgl) #needed to make 3D plots
#library(xts) #needed to convert data frame to time series
```

b) Loading data...
Note, ensure date data is formatted in R as Date.

```{r}
Me_algae<- read.csv(file="Cleaned_data/Mendota_Algae.csv") #read in the file with predictor variables
Me_algae<- Me_algae %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30"), #format as date
         X=NULL) #remove extra column
Me_extLoad<- read.csv(file="Cleaned_data/Mendota_P_allext.csv")
Me_extLoad<- Me_extLoad %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30"), #format as date
         X=NULL) #remove extra column
Me_intLoad<- read.csv(file="Cleaned_data/Mendota_P_water.csv")
Me_intLoad <- Me_intLoad %>%
  mutate(sampledate=as.Date(sampledate, origin="1899-12-30"), #format as date
         X=NULL) #remove extra column
```

# Step 2. Merge the data into one file:
Note, you can only merge two files at one time.

a) merging response and external loading data....

```{r}
Me_all<- merge(Me_algae, Me_extLoad, by="sampledate")
Me_all<- merge(Me_all, Me_intLoad, by="sampledate")
Me_all<- Me_all %>%
  mutate(Yr=Yr.x, #rename field
         Yr.x=NULL, #delete extra field
         daynum=daynum.x, #rename field
         daynum.x=NULL, #delete extra field
         Yr.y=NULL, #delete extra field
         daynum.y=NULL) #delete extra field
```

# Step 3. Calculate lagged data:
Note, Time series regression model assumes the time series "Y" has a linear 
relationship with the times series "X". But, you need to subset the response 
variable(s) to the CyanoHAB season (daynum > 195 & < 255).To do this, I need to
make a new time series with the current chl-a and the t-k, when k = 7, 14, 30.

creating a new data frame with lagged variables...

```{r}
water_int_k<- transform(Me_all, HE_ratio_k=lag(HE_ratio_TotP_mgL, n=7), 
                        #adds column with X_1, t-7 value
                        totextP_kgday_k=lag(totextP_kgday, n=14), 
                        #adds column with X_2, t-14 value
                        Chla_ugL_k=lag(Chla_ugL, n=7), 
                        #adds column with Y_1, t-7 value
                        CyanoDens_cellsmL_k=lag(CyanoDens_cellsmL, n=7) 
                        #adds column with Y_2, t-7 value
)
water_int_k<- water_int_k %>%
  filter(daynum < 255 & daynum > 195) #filters the data for the CyanoHAB season
```

Lagged data computed.

# Step 4. Check data for normality to determine whether transformation needed:
If data is normally distributed, then you can use simple linear regression or 
ANOVA. If data is non-normally distributed, then you need to pick a 
non-parametric model. The general linear model does not require 
normal-distribution.

checking for normality...

```{r}
hist(water_int_k$Chla_ugL, breaks=100) #prints histograph of Chl-a
#data right skewed
hist(log10(water_int_k$Chla_ugL), breaks=100) #prints histograph of log10(Chl-a)
#log-transform data is more normal
hist(water_int_k$CyanoDens_cellsmL, breaks=100) #prints histograph of CD
#data right skewed
hist(log10(water_int_k$CyanoDens_cellsmL), breaks=100) #prints histograph of log10(CD)
#log-transform data is more normal
hist(water_int_k$totextP_kgday, breaks=100) #prints hist of ext load term
#data right skewed
hist(log10(water_int_k$totextP_kgday), breaks=100) #prints hist of ext load term
#data more normal, but still right skewed
hist(water_int_k$HE_ratio_TotP_mgL, breaks=100) #prints hist of int load term
#data right-skewed
hist(log10(water_int_k$HE_ratio_TotP_mgL), breaks=100) #prints hist of int load 
#data more normal
```

All data is positively skewed, so both predictor and response variables 
need to be transformed to log 10 for modeling.


# Step 5. Perform regression:

a) Run simplest model for each response variable...

Chla_t = Chla_t-7 + error...

```{r}
plot(log10(water_int_k$Chla_ugL)~log10(water_int_k$Chla_ugL_k), 
     xlab="Total Chlorophyll-a, 7 days prior (ug/L), log10-transformed",
     ylab="Total Chlorophyll-a (ug/L), log10-transformed")
regk1_Chla<- glm(data=na.omit(water_int_k), #removes nas
            formula= log10(Chla_ugL+0.1)~log10(Chla_ugL_k+0.1)) #add 0.1 to avoid log10=NA
summary(regk1_Chla) #prints the glm output
aov(regk1_Chla) #prints the sum of squares for the regression and residuals
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(regk1_Chla) #prints diagnostic graphs for regression
par(mfrow=c(1,1))#returns graphing viewer to 1 plot per page
```

CD_t = CD_t-7 + error...

```{r}
plot(log10(water_int_k$CyanoDens_cellsmL)~log10(water_int_k$CyanoDens_cellsmL_k), 
     xlab="Cyanobacteria density, 7 days prior (cells/mL), log10-transformed",
     ylab="Cyanobacteria density (cells/mL), log10-transformed")
regk1_CD<- glm(data=na.omit(water_int_k),
            formula=log10(CyanoDens_cellsmL)~log10(CyanoDens_cellsmL_k)) #Y_2, t-k as predictor variable
summary(regk1_CD) #prints the glm output
aov(regk1_CD)#prints the sum of squares for the regression and residuals
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(regk1_CD) #prints diagnostic graphs for regression
par(mfrow=c(1,1))#returns graphing viewer to 1 plot per page
```

b) Run 2nd model for each response variable...

Chla_t = hypoP:epiP_t-7 + error...

```{r}
plot(log10(water_int_k$Chla_ugL)~log10(water_int_k$HE_ratio_k), 
     xlab="Hypo: Epi ratio of total P, 7 days before, log10-transformed",
     ylab="Total Chlorophyll-a (ug/L), log10-transformed")
regk2_Chla<- glm(data=na.omit(water_int_k),
                 formula=log10(Chla_ugL+0.1)~log10(HE_ratio_k)) #X1 predictor variable
summary(regk2_Chla) #prints the glm output
aov(regk2_Chla)#prints the sum of squares for the regression and residuals
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(regk2_Chla) #prints diagnostic graphs for regression
par(mfrow=c(1,1)) #returns graphing viewer to 1 plot per page
```

CD_t = hypoP:epiP_t-7 + error...

```{r}
plot(log10(water_int_k$CyanoDens_cellsmL)~log10(water_int_k$HE_ratio_k), 
     xlab="Hypo: Epi ratio of total P, 7 days before, log10-transformed",
     ylab="Cyanobacteria density (cells/mL), log10-transformed")
regk2_CD<- glm(data=water_int_k,
               formula=log10(CyanoDens_cellsmL)~log10(water_int_k$HE_ratio_k)) #X1 predictor variable
summary(regk2_CD) #prints the glm output
aov(regk2_CD)#prints the sum of squares for the regression and residuals
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(regk2_CD) #prints diagnostic graphs for regression
par(mfrow=c(1,1)) #returns graphing viewer to 1 plot per page
```

c) Run 3rd model for each response variable...  

Chla_t = ExtPLoad_t-14 + error...

```{r}
plot(log10(water_int_k$Chla_ugL)~log10(water_int_k$totextP_kgday_k), 
     xlab="Total P external loading, 14 days before (kg/day), log-transformed",
     ylab="Total Chlorophyll-a (ug/L), log-transformed")
regk3_Chla<- glm(data=water_int_k,
            formula=log10(Chla_ugL+0.1)~log10(totextP_kgday_k)) 
summary(regk3_Chla) #prints the glm output
aov(regk3_Chla)#prints the sum of squares for the regression and residuals
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(regk3_Chla) #prints diagnostic graphs for regression
par(mfrow=c(1,1))
```

CD_t = ExtPLoad_t-14 + error...

```{r}
plot(log10(water_int_k$CyanoDens_cellsmL)~log10(water_int_k$totextP_kgday_k), 
     xlab="Total P external loading, 14 days before (kg/day), log-transformed",
     ylab="Cyanobacteria Density (cells/mL), log-transformed")
regk3_CD<- glm(data=water_int_k,
            formula=log10(CyanoDens_cellsmL)~log10(totextP_kgday_k))
summary(regk3_CD)#prints the glm output
aov(regk3_CD)#prints the sum of squares for the regression and residuals
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(regk3_CD) #prints diagnostic graphs for regression
par(mfrow=c(1,1))
```

d) Run 4th model for each response variable...

Chla_t = hypoP:epiP_t-7 + ExtPLoad_t-14 + error...

```{r}
regk4_Chla<- glm(formula=log10(Chla_ugL+0.1) ~ #response variable
             log10(HE_ratio_k) + #X1 predictor variable
              log10(totextP_kgday_k), #X2 predictor variable
              data=water_int_k) #data frame
summary(regk4_Chla)#prints the glm output
aov(regk4_Chla)#prints the sum of squares for the regression and residuals
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(regk4_Chla) #prints diagnostic graphs for regression
par(mfrow=c(1,1))
```

CD_t = hypoP:epiP_t-7 + ExtPLoad_t-14 + error...

```{r}
regk4_CD<- glm(formula=log10(CyanoDens_cellsmL) ~ #response variable
             log10(HE_ratio_k) + #X1 predictor variable
              log10(totextP_kgday_k), #X2 predictor variable
              data=water_int_k) #data frame
summary(regk4_CD)
aov(regk4_CD)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(regk4_CD) #prints diagnostic graphs for regression
par(mfrow=c(1,1))
```

e) Run 5th model for each response variable...

Chla_t = hypoP:epiP_t-7 + ExtPLoad_t-14 + Chla_t-7 + error...

```{r}
regk5_Chla<- glm(formula=log10(Chla_ugL+0.1) ~ #response variable
             log10(HE_ratio_k) + #X1 predictor variable
              log10(totextP_kgday_k) +
               log10(Chla_ugL_k+0.1), #X2 predictor variable
              data=water_int_k) #data frame
summary(regk5_Chla)#prints the glm output
aov(regk5_Chla)#prints the sum of squares for the regression and residuals
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(regk5_Chla) #prints diagnostic graphs for regression
par(mfrow=c(1,1))
```

CD_t = hypoP:epiP_t-7 + ExtPLoad_t-14  + CD_t-7 + error...

```{r}
regk5_CD<- glm(formula=log10(CyanoDens_cellsmL) ~ #response variable
             log10(HE_ratio_k) + #X1 predictor variable
              log10(totextP_kgday_k) +
               log10(CyanoDens_cellsmL_k), #X2 predictor variable
              data=water_int_k) #data frame
summary(regk5_CD)
aov(regk5_CD)
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(regk5_CD) #prints diagnostic graphs for regression
par(mfrow=c(1,1))
```

# Step 6. Compare the models:
The model with the lowest AIC, Residual standard error, and each term is
significant (t-score p-valu < 0.05) is the best model.

# Step 7. Compare the output by year:

```{r}
regk5_Chla<- glm(formula=log10(Chla_ugL+0.1) ~ #response variable
             log10(HE_ratio_k) + #X1 predictor variable
              log10(totextP_kgday_k) +#x2 predictor variable
               log10(Chla_ugL_k+0.1), #X3 predctor variable
              data=subset(water_int_k, Yr==2018) #data from year z
             )
aov(regk5_Chla)#prints the sum of squares for the regression and residuals
```

```{r}
regk5_CD<- glm(formula=log10(CyanoDens_cellsmL) ~ #response variable
             log10(HE_ratio_k) + #X1 predictor variable
              log10(totextP_kgday_k) +
               log10(CyanoDens_cellsmL_k), #X2 predictor variable
              data=subset(water_int_k, Yr==2018) #data frame
            )
aov(regk5_CD)
```

# Step 8. Making a 3D plot of the selected model:

```{r}
mycols <- colorRampPalette( c("green", "red") )
plot3d( 
  x=log10(water_int_k$HE_ratio_k), 
  y=water_int_k$totextP_kgday_k, 
  z=(water_int_k$Chla_ugL), 
  colvar=(water_int_k$Chla_ugL),
  type = 's', 
  size=0.75,
  xlab="Hypo: Epi P ratio", 
  ylab="Total P external load (lb/day)", 
  zlab="Total Chl-a from 7 days before (ug/L)")
rglwidget()
```
