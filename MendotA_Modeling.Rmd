---
title: "Mendota_Modeling.Rmd"
author: "Lauren A. Knose, ORISE-EPA"
date: '2023-06-23'
output: html_document
---




______________Old Colde_____________________

# Step 4. Analyze the response variables by predictors:

a) Question: Does epilimnion total P concentration correlate with chl-a?

combining data files...
```{r}
Chl_moyr<- Me_Chl %>%
  group_by(MoYr) %>%
  summarise(Avg_Chla_ugL=mean(Chla_ugL, na.rm=TRUE)) %>%
  mutate(MoYr=as.Date(MoYr, format="%m/%d/%Y", origin="1899-12-30"))
P_Chl<- merge(Chl_moyr, Pratio, by="MoYr", all=TRUE)
P_Chl<- P_Chl %>%
  filter(!is.na(TotP_mgL_Epi),
         !is.na(TotP_mgL_Hypo)) 
```

setting up plot...

```{r}
ggplot(data=P_Chl, aes(x=TotP_mgL_Epi, y=Avg_Chla_ugL))+
  geom_point() + 
  scale_y_continuous(trans="log10") +
  labs(title = "Lake Mendota, WI",
       x="Epilimnion total phosphorus (mg/L)",
       y="Total Algal Biomass as Chl-a (ug/L), log scale",
       caption= "Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_smooth()  #adds loess curve (moving average regression model)
```

b) Question: Does hypolimion total P concentration correlate with Chl-a?

```{r}
ggplot(data=P_Chl, aes(x=TotP_mgL_Hypo, y=Avg_Chla_ugL))+
  geom_point() + 
  scale_y_continuous(trans="log10") +
  labs(title = "Lake Mendota, WI",
       x="Hypolimnion total phosphorus (mg/L)",
       y="Total Algal Biomass as Chl-a (ug/L), log scale",
       caption= "Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_smooth()  #adds loess curve (moving average regression model)
```

c) Question: Does Hypo: Epi total P concentration correlate with Chl-a?

```{r}
ggplot(data=P_Chl, aes(x=HE_ratio_TotP_mgL, y=Avg_Chla_ugL))+
  geom_point() + 
  scale_y_continuous(trans="log10") +
  scale_x_continuous(trans="log10") +
  labs(title = "Lake Mendota, WI",
       x="Hypo: Epi total phosphorus ratio (mg/L)",
       y="Total Algal Biomass as Chl-a (ug/L), log scale",
       caption= "Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_smooth()  #adds loess curve (moving average regression model)
```


d) Question: Does epilimnion total P concentration correlate with cyano relative biovolume?

combining data files...
```{r}
CyanoRB_moyr<- Me_cyanoRB %>%
  mutate(MoYr=format(sampledate, "%m/01/%Y")) %>%
  group_by(MoYr) %>%
  summarise(Avg_relbiovol=mean(relbiovol, na.rm=TRUE)) %>%
  mutate(MoYr=as.Date(MoYr, format="%m/%d/%Y", origin="1899-12-30"))
P_Cyano<- merge(CyanoRB_moyr, Pratio, by="MoYr", all=TRUE)
P_Cyano<- P_Cyano %>%
  filter(!is.na(TotP_mgL_Epi),
         !is.na(TotP_mgL_Hypo)) 
```

setting up plot...

```{r}
ggplot(data=P_Cyano, aes(x=TotP_mgL_Epi, y=Avg_relbiovol))+
  geom_point() + 
  scale_y_continuous(trans="log10") +
  labs(title = "Lake Mendota, WI",
       x="Epilimnion total phosphorus (mg/L)",
       y="Cyanobacteria relative biovolume (as % of total), log scale",
       caption= "Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_smooth()  #adds loess curve (moving average regression model)
```

e) Question: Does hypolimnion total P concentration correlate with cyano relative biovolume?

```{r}
ggplot(data=P_Cyano, aes(x=TotP_mgL_Hypo, y=Avg_relbiovol))+
  geom_point() + 
  scale_y_continuous(trans="log10") +
  labs(title = "Lake Mendota, WI",
       x="Hypolimnion total phosphorus (mg/L)",
       y="Cyanobacteria relative biovolume (as % of total), log scale",
       caption= "Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_smooth()  #adds loess curve (moving average regression model)
```

f) Question: Does hypo: epi total P concentration correlate with cyano relative biovolume?

```{r}
ggplot(data=P_Cyano, aes(x=HE_ratio_TotP_mgL, y=Avg_relbiovol))+
  geom_point() + 
  scale_y_continuous(trans="log10") +
  scale_x_continuous(trans="log10") +
  labs(title = "Lake Mendota, WI",
       x="Hypolimnion total phosphorus (mg/L)",
       y="Cyanobacteria relative biovolume (as % of total), log scale",
       caption= "Source: Lake Mendota,North Temperate Lakes Dataset") +
  theme_classic()+
  geom_smooth()  #adds loess curve (moving average regression model)
```

____________NEEDS UPDATED_____________________________

g) Question: Does total P loading from inflows predict Chl-a?

```{r}
ggplot(data=P_Chl, aes(x=TotPload_gday/1000, y=Chla_ugL)
       ) + 
  geom_point() +
  theme_classic() + 
  labs(title="Lake Mendota, WI",
       x="Total P loading (kg/day)",
       y="Total Algal Biomass (Chl-a ug/L)") +
  scale_y_continuous(trans = 'log10') +
  scale_x_continuous(trans = 'log10') 
```

Nope, not at all. Plot of Chla by total P loading shows no correlation.

Question: Does total P export in outflow predict Chl-a?

```{r}
ggplot(data=P_Chl, aes(x=TotPexp_gday/1000, y=Chla_ugL)
       ) + 
  geom_point() +
  theme_classic() + 
  labs(title="Lake Mendota, WI",
       x="Total P export (kg/day)",
       y="Total Algal Biomass (Chl-a ug/L)") +
  scale_y_continuous(trans = 'log10') +
  scale_x_continuous(trans = 'log10') 
```

Plot of Chla by total P export shows no correlation.

Question: Does total P stored/released predict Chl-a?

```{r}
ggplot(data=P_Chl, aes(x=P_stored_gday/1000, y=Chla_ugL)
       ) + 
  geom_point() +
  theme_classic() + 
  labs(title="Lake Mendota, WI",
       x="Total P stored (+) or released (-) (kg/day)",
       y="Total Algal Biomass (Chl-a ug/L)") +
  scale_y_continuous(trans = 'log10') +
  geom_vline(xintercept = 0, lty="dashed")
```

Plot of Chla by P stored or released shows almost all the data points to the left of the zero line. 

```{r}
ggplot(data=subset(P_Chl, daynum >= 195 & daynum <=255), aes(x=P_stored_gday/1000, y=Chla_ugL)) + 
  geom_point() +
  theme_classic() + 
  labs(title="CyanoHAB Season, Lake Mendota, WI",
       x="Total P stored (+) or released (-) (kg/day)",
       y="Total Algal Biomass (Chl-a ug/L)") +
  #scale_y_continuous(trans='log10') +
  #scale_x_continous(trans='log10) +
  geom_vline(xintercept = 0, lty="dashed")
```

Even during the CyanoHAB season, there's no relationship!!!


Plot Chl-a by internal load:

```{r}
ggplot(data=P_Chl_yr) + 
  geom_point(aes(x=Net_IL_gyr, y=MaxChl_ugL)) +
  geom_line(aes(x=TotPload_gyr, y=MaxChl_ugL)) +
  theme_classic() + 
  labs(title="CyanoHAB Season, Lake Mendota, WI",
       x="Net Annual Internal Loading (g/yr)",
       y="Maximum Algal Biomass (Chl-a ug/L)") 
  #scale_y_continuous(trans='log10') +
  #scale_x_continous(trans='log10) +
```





```{r}
hypo_sum_ME_TP<- read.csv(file.choose(), header=TRUE) #choose from Cleaned data folder
hypo_sum_ME_TP$mo=NULL #remove unwanted column
hypo_sum_ME_TP <- hypo_sum_ME_TP %>%
  mutate(sampledate=as.Date(sampledate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30")) #tells R to format 
          #data as date
sum_ME_Chl<- sum_ME_Chl %>%
  mutate(sampledate=as.Date(sampledate, 
                            format="%m/%d/%Y",
                            origin="1899-12-30")) #tells R to format 
          #data as date
combA<- merge(hypo_sum_ME_TP, sum_ME_Chl, 
              by=c("sampledate", "year4", "daynum", "Use_Jdate"),
              all.x=TRUE,all.y=TRUE)
combA$sd_hypo_TP=NULL #don't need this column
combA<- na.omit(combA) #removes NAs (from 140 records to 59 records)

ggplot(data=combA, aes(x=(mean_hypo_TP*1000), y=Chl_ugL)) + 
  geom_point()+
  geom_smooth(method="lm", data=subset(combA, mean_hypo_TP > 0.1)) +
  geom_smooth(method="lm", data=subset(combA, mean_hypo_TP < 0.1)) +
  theme_classic()+
  labs(x="Hypolimion total P (ug/L)",
       y="Total algal biomass (ug Chl-a/L)",
       title="Summer, mid-July to mid-September, Lake Mendota, WI",
       caption="Source: Lake Mendota, North Temperate Lakes Dataset")
```

First, join the two tables...

```{r}
sum_ME_Chl<-read.csv(file.choose(), header=TRUE) #file in Cleaned_data folder
sum_ME_Chl$depth_range_m=NULL
sum_ME_Chl$mo=NULL
joined_TPChl<- merge(hypo_sum_ME_TP, sum_ME_Chl, by=c("sampledate", "year4",
                                                      "Use_Jdate","daynum"))
joined_TPChl_epi<-merge(epi_sum_ME_TP, sum_ME_Chl, by=c("sampledate", "year4",
                                                      "Use_Jdate","daynum"))
```

Then, build the plot for EPI TP...

```{r}
ylim.prim <- c(0, 0.15)   #total P range in mg/L
ylim.sec <- c(0, 60)    # chl-a range in ug/L

b <- diff(ylim.prim)/diff(ylim.sec)
a <- ylim.prim[1] - b*ylim.sec[1] 

ggplot(data=joined_TPChl_epi, aes(x=Use_Jdate)) + 
  facet_wrap(~year4) +
  geom_line(aes(y=totpuf_sloh)) +
  geom_point(aes(y = a + Chl_ugL*b)) +
  theme_classic() +
  theme(legend.justification=c("right", "top")) +
  labs(x="Day of Year", y="Mean Total P (ug/L)",
       title="Summer Epilimnion, mid-July to mid-September, Lake Mendota, WI",
       caption="Source: Lake Mendota,North Temperate Lakes Dataset",
       colour="Year") +
  scale_y_continuous(sec.axis=sec_axis(~ (. - a)/b, 
                                       name="Total Chlorophyll-a (ug/L)")) +
  geom_hline(yintercept=20/400, col="red", lty="dashed")
```

Then, build the plot for Hypo TP...

```{r}
ylim.prim <- c(0, 0.6)   #total P range in mg/L
ylim.sec <- c(0, 60)    # chl-a range in ug/L

b <- diff(ylim.prim)/diff(ylim.sec)
a <- ylim.prim[1] - b*ylim.sec[1] 

ggplot(data=joined_TPChl, aes(x=Use_Jdate)) + 
  facet_wrap(~year4) +
  geom_line(aes(y=mean_hypo_TP)) +
  geom_point(aes(y = a + Chl_ugL*b)) +
  theme_classic() +
  theme(legend.justification=c("right", "top")) +
  labs(x="Day of Year", y="Hypo Total P (ug/L)",
       title="Summer Hypolimnion, mid-July to mid-September, Lake Mendota, WI",
       caption="Source: Lake Mendota,North Temperate Lakes Dataset",
       colour="Year") +
  scale_y_continuous(sec.axis=sec_axis(~ (. - a)/b, 
                                       name="Total Chlorophyll-a (ug/L)")) +
  geom_hline(yintercept=20/100, col="red", lty="dashed")
```
